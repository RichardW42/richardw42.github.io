<!doctype html><html><head><title>beancount 简易入门指南</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=keywords content="beancount,记账"><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-164155675-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-164155675-1');</script><script src=/vendor/js/jquery.min.js></script><script src=/vendor/js/popper.min.js></script><script src=/vendor/js/bootstrap.min.js></script><script src=/vendor/js/smooth-scroll.polyfills.min.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><script src=/vendor/js/vue.min.js></script><link rel=icon href=/favicon.png><link rel=stylesheet href=https://yuchi.me/zh.journal.min.61c96af618f6e0e038e54359d29edfbb60c5d7a9e9327866126dbdeb69ce6253.css integrity="sha256-Yclq9hj24OA45UNZ0p7fu2DF16npMnhmEm2962nOYlM=" media=screen><link rel=stylesheet href=https://yuchi.me/zh.darkmode.min.947ee7777df04387f743701f79acd617dc8275294e917b17598964f7eef70ca8.css integrity="sha256-lH7nd33wQ4f3Q3AfeazWF9yCdSlOkXsXWYlk9+73DKg=" media=screen><script src=https://yuchi.me//js/loadCSS.js></script><script>loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");</script><script src=https://yuchi.me//js/toc-collapse.js></script><script src=https://cdn.jsdelivr.net/npm/vue-disqus@3/dist/vue-disqus.js></script></head><body><div id=app><div ref=sideContainer class=side-container><a class="a-block nav-head false" href=/><div class=nav-title>Chi's Journal</div><div class=nav-subtitle>- Ecclesiastes 1.11</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/post/>归档</a>
<a class="a-block nav-link-item false" href=/tags/>标签</a><div class=nav-link-item></div><div class=nav-link-item><a href=https://twitter.com/wych42 target=_blank><i title=Twitter class="fab fa-twitter"></i></a><a href=https://yuchi.me//index.xml target=_blank><i title=Feed class="fas fa-rss"></i></a></div></div><div class=nav-footer>Written with <a target=_blank rel="noreferrer noopener" href=https://www.gnu.org/software/emacs/>Emacs</a> and <a target=_blank rel="noreferrer noopener" href=https://orgmode.org/>Org-mode</a>.<br>Rendered by <a target=_blank rel="noreferrer noopener" href=https://gohugo.io>Hugo</a>.<br>Theme <a target=_blank rel="noreferrer noopener" href=https://github.com/amazingrise/hugo-theme-diary>Diary</a>(Modified).<br>Converted by <a target=_blank rel="noreferrer noopener" href=https://ox-hugo.scripter.co/>ox-hugo</a>.<br>&copy;
2020 Chi's Journal</div></div><div ref=extraContainer class=extra-container><div class="toc animated-visibility"><div class=toc-content><center>- 目录 -</center><ul><ul class=collapse data-toggle=collapse><li><a href=#%e8%83%8c%e6%99%af%e7%9f%a5%e8%af%86 onclick="collapseOthers(`#背景知识-nav`)" id=背景知识-nav>背景知识</a></li><li><a href=#%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84 onclick="collapseOthers(`#目录结构-nav`)" id=目录结构-nav>目录结构</a></li><li><a href=#%e5%bc%80%e8%ae%be%e8%b4%a6%e6%88%b7 onclick="collapseOthers(`#开设账户-nav`)" id=开设账户-nav>开设账户</a></li><ul class=collapse data-toggle=collapse><li><a href=#options onclick="collapseOthers(`#options-nav`)" id=options-nav>Options</a></li><li><a href=#accounts onclick="collapseOthers(`#accounts-nav`)" id=accounts-nav>Accounts</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e5%a6%82%e4%bd%95%e9%80%89%e6%8b%a9%e8%b4%a6%e6%88%b7%e5%88%9d%e5%a7%8b%e6%97%a5%e6%9c%9f onclick="collapseOthers(`#如何选择账户初始日期-nav`)" id=如何选择账户初始日期-nav>如何选择账户初始日期？</a></li><li><a href=#assets onclick="collapseOthers(`#assets-nav`)" id=assets-nav>Assets</a></li><li><a href=#liabilities onclick="collapseOthers(`#liabilities-nav`)" id=liabilities-nav>Liabilities</a></li><li><a href=#income onclick="collapseOthers(`#income-nav`)" id=income-nav>Income</a></li><li><a href=#expenses onclick="collapseOthers(`#expenses-nav`)" id=expenses-nav>Expenses</a></li><li><a href=#equity onclick="collapseOthers(`#equity-nav`)" id=equity-nav>Equity</a></li></ul><li><a href=#balance onclick="collapseOthers(`#balance-nav`)" id=balance-nav>Balance</a></li></ul><li><a href=#%e5%af%bc%e5%85%a5%e6%95%b0%e6%8d%ae onclick="collapseOthers(`#导入数据-nav`)" id=导入数据-nav>导入数据</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e8%8e%b7%e5%8f%96%e6%95%b0%e6%8d%ae onclick="collapseOthers(`#获取数据-nav`)" id=获取数据-nav>获取数据</a></li><li><a href=#%e5%87%86%e5%a4%87%e6%95%b0%e6%8d%ae onclick="collapseOthers(`#准备数据-nav`)" id=准备数据-nav>准备数据</a></li><li><a href=#import-%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#import-配置-nav`)" id=import-配置-nav>import 配置</a></li><li><a href=#%e6%89%a7%e8%a1%8c%e5%af%bc%e5%85%a5 onclick="collapseOthers(`#执行导入-nav`)" id=执行导入-nav>执行导入</a></li></ul><li><a href=#%e6%88%91%e7%9a%84%e5%b7%a5%e4%bd%9c%e6%b5%81 onclick="collapseOthers(`#我的工作流-nav`)" id=我的工作流-nav>我的工作流</a></li><li><a href=#%e6%80%bb%e7%bb%93 onclick="collapseOthers(`#总结-nav`)" id=总结-nav>总结</a></li></ul></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a class=pagination-action v-on:click=toggleDarkMode><i class="material-icons pagination-action-icon" v-if=isDarkMode>brightness_4</i>
<i class="material-icons pagination-action-icon" v-else=isDarkMode>brightness_7</i></a></div></div><div class=single-column-drawer-container ref=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/post/>归档</a>
<a class="a-block drawer-menu-item false" href=/tags/>标签</a><div class="a-block drawer-menu-item false"></div><div class="a-block drawer-menu-item false"><a href=https://twitter.com/wych42 target=_blank><i title=Twitter class="fab fa-twitter"></i></a><a href=https://yuchi.me//index.xml target=_blank><i title=Feed class="fas fa-rss"></i></a></div><div class=toc><div class=toc-content><center>- 目录 -</center><ul><ul class=collapse data-toggle=collapse><li><a href=#%e8%83%8c%e6%99%af%e7%9f%a5%e8%af%86 onclick="collapseOthers(`#背景知识-nav`)" id=背景知识-nav>背景知识</a></li><li><a href=#%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84 onclick="collapseOthers(`#目录结构-nav`)" id=目录结构-nav>目录结构</a></li><li><a href=#%e5%bc%80%e8%ae%be%e8%b4%a6%e6%88%b7 onclick="collapseOthers(`#开设账户-nav`)" id=开设账户-nav>开设账户</a></li><ul class=collapse data-toggle=collapse><li><a href=#options onclick="collapseOthers(`#options-nav`)" id=options-nav>Options</a></li><li><a href=#accounts onclick="collapseOthers(`#accounts-nav`)" id=accounts-nav>Accounts</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e5%a6%82%e4%bd%95%e9%80%89%e6%8b%a9%e8%b4%a6%e6%88%b7%e5%88%9d%e5%a7%8b%e6%97%a5%e6%9c%9f onclick="collapseOthers(`#如何选择账户初始日期-nav`)" id=如何选择账户初始日期-nav>如何选择账户初始日期？</a></li><li><a href=#assets onclick="collapseOthers(`#assets-nav`)" id=assets-nav>Assets</a></li><li><a href=#liabilities onclick="collapseOthers(`#liabilities-nav`)" id=liabilities-nav>Liabilities</a></li><li><a href=#income onclick="collapseOthers(`#income-nav`)" id=income-nav>Income</a></li><li><a href=#expenses onclick="collapseOthers(`#expenses-nav`)" id=expenses-nav>Expenses</a></li><li><a href=#equity onclick="collapseOthers(`#equity-nav`)" id=equity-nav>Equity</a></li></ul><li><a href=#balance onclick="collapseOthers(`#balance-nav`)" id=balance-nav>Balance</a></li></ul><li><a href=#%e5%af%bc%e5%85%a5%e6%95%b0%e6%8d%ae onclick="collapseOthers(`#导入数据-nav`)" id=导入数据-nav>导入数据</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e8%8e%b7%e5%8f%96%e6%95%b0%e6%8d%ae onclick="collapseOthers(`#获取数据-nav`)" id=获取数据-nav>获取数据</a></li><li><a href=#%e5%87%86%e5%a4%87%e6%95%b0%e6%8d%ae onclick="collapseOthers(`#准备数据-nav`)" id=准备数据-nav>准备数据</a></li><li><a href=#import-%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#import-配置-nav`)" id=import-配置-nav>import 配置</a></li><li><a href=#%e6%89%a7%e8%a1%8c%e5%af%bc%e5%85%a5 onclick="collapseOthers(`#执行导入-nav`)" id=执行导入-nav>执行导入</a></li></ul><li><a href=#%e6%88%91%e7%9a%84%e5%b7%a5%e4%bd%9c%e6%b5%81 onclick="collapseOthers(`#我的工作流-nav`)" id=我的工作流-nav>我的工作流</a></li><li><a href=#%e6%80%bb%e7%bb%93 onclick="collapseOthers(`#总结-nav`)" id=总结-nav>总结</a></li></ul></div></div></div></div></div><transition name=fade><div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav ref=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div ref=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a ref=navTitle class=navbar-brand href=https://yuchi.me/>Chi's Journal</a>
<button type=button class=nav-darkmode-toggle v-on:click=toggleDarkMode>
<i class=material-icons v-if=isDarkMode>brightness_4</i>
<i class=material-icons v-else=isDarkMode>brightness_7</i></button></div></nav><div class=single-column-header-container ref=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://yuchi.me/><div class=single-column-header-title>Chi's Journal</div><div class=single-column-header-subtitle>- Ecclesiastes 1.11</div></a></div><div id=content><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>beancount 简易入门指南<div class=post-meta><time itemprop=datePublished>2018-10-25 12:25</time>
<i class=material-icons>folder</i>
<a href=/categories/>[Post]</a>
&nbsp;
<i class=material-icons>label</i>
<a href=/tags/beancount>beancount</a>
&nbsp;
<a href=/tags/%E8%AE%B0%E8%B4%A6>记账</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><p>beancount 是一个基于文本、命令行的复式记账软件，上周看到了 <a href=https://wzyboy.im/post/1063.html rel=noreferrer target=_blank>wzyboy</a> 介绍这个工具以及复式记账的基础概念的安利文。花了一点时间入坑之后，自己的资产（存款）、收入、消费去向，一目了然。看到食物消费和打车话费在支出的 TreeMap 里占据的两大块，不禁让我反思起平时的好吃懒做。</p><p>如果你跟我类似：</p><ul><li>靠月工资流水生存，有强烈的意愿、需求理清自己的财务状态，搞清楚钱从哪里来、花到哪里去、留下了多少，并借机改善；</li><li>虽然平时也用过鲨鱼记账、随手记之类的 App，但是觉得每一次消费后掏出手机、打开 App、填写金额时间用途，是一个很重的中断行为；也懒得定期手工录入一批账单；</li><li>绝大多数消费最终都由银行账户结算，例如通过支付宝绑定信用卡快捷支付，最终只需要统计银行账单即可；</li><li>懂一点编程（简单的 Python 基础即可），愿意付出一点时间学习；</li></ul><p>那么，beancount 这个工具会是一个比较合适的开始。</p><p>本文将从一个新手了解了基础概念之后，如何迈出第一步，把现存的财务状态映射到 beancount 里的角度，介绍一下个人的实践经验。</p><h2 id=背景知识>背景知识</h2><p>后文假设读者已经读过下列文档、或者熟悉下面文档中提及的工具和概念。</p><ul><li><a href=https://wzyboy.im/post/1063.html rel=noreferrer target=_blank>Beancount —— 命令行复式簿记</a> wzyboy 的安利文，中文文档</li></ul><p>如果有时间，推荐再读一下 beancount 作者写的几篇文档：</p><ul><li><a href=https://docs.google.com/document/d/100tGcA4blh6KSXPRGCZpUlyxaRUwFHEvnz_k9DyZFn4/edit rel=noreferrer target=_blank>Beancount - The Double-Entry Counting Method</a></li><li><a href=https://docs.google.com/document/d/1G-gsmwK551lSyuHboVLW3xbLhh99JfoKIbNnZSJxteE/edit rel=noreferrer target=_blank>Beancount - Tutorial & Example</a></li></ul><p>还有更多的细节、示例可以参考这个索引<a href=https://docs.google.com/document/d/1RaondTJCS_IUPBHFNdT8oqFKJjVJDsfsn6JEjBG04eA/edit rel=noreferrer target=_blank>文档</a>。</p><h2 id=目录结构>目录结构</h2><p>使用如下所示的目录结构：</p><pre><code class=language-nil data-lang=nil>~/Documents/accounting
├── documents
│   ├── Assets/
│   ├── Expenses/
│   ├── Income/
│   └── Liabilities/
├── documents.tmp/
├── importers
│   ├── __init__.py
├── yc.bean
└── yc.import</code></pre><ul><li>~/Documents/accounting: 项目的根目录，放在任何想放的地方;</li><li>documents: 用于导入第三方数据后，使用 bean-file 归类存档原文件，执行 <code>mkdir documents/{Assets,Expenses,Inconme,Liabilities}</code> 创建这些目录;</li><li>documents.tmp: 用于临时存放待导入的第三方数据，比如银行卡账单，可以是其他路径，比如 <code>/tmp</code>, bean-extract, bean-file 这些脚本都要用到这个目录;</li><li>importers: 用于存放自定义的导入脚本，目前自带的导入器足够使用，可以先不管这个目录;</li><li>yc.import: 实际上是一个 Python 脚本，用于定义导入器的配置，后面细说;</li><li>yc.bean: 是实际的账簿文件，账户、交易记录都在这里，生成报表也使用这个文件,可以将账簿文件拆分成多个小文件，再使用 <code>include</code> 指令拼接，类似 C 语言或者 Python 里的 <code>import</code>;</li></ul><details><summary>单文件账簿还是拆分多文件账簿？</summary>
- 刚开始建议用一个 `.bean` 文件管理所有的记录，熟悉工具的使用流程、有了明确的需求之后再拆分;
- 如果使用 emacs 的 orgmode 编辑账簿文件，建议一直使用一个 `.bean` 文件，非常好用;</details><p>刚开始使用，只需要关注主账簿文件 <code>yc.bean</code> 就行，我们来一探究竟吧。</p><h2 id=开设账户>开设账户</h2><p>我的 <code>yc.bean</code> 文件顶层有三部分: Options, Accounts, MonthlyReconciliation，分别对应账簿文件的选项，账户，每月对账。</p><h3 id=options>Options</h3><p>设置账簿的 title，定义账簿里会用到的货币。</p><pre><code class=language-nil data-lang=nil>\* Options
option &#34;title&#34; &#34;My Personal Ledger&#34;
option &#34;operating_currency&#34; &#34;CNY&#34;
option &#34;operating_currency&#34; &#34;USD&#34;</code></pre><h3 id=accounts>Accounts</h3><p>有五种账户类型: Assets,Liabilities,Equity,Income,Expenses。分别对应资产、负债、初始化账簿时已有的数据、收入、支出，详细含义可以看上面提及的推荐阅读文档里。</p><p>在 benacount 里会隐式创建树形账户，也就是如果开了一个账户叫做： <code>Assets:Bank:BoC:CardXXXX</code>, 那么会自动生成账户 <code>Assets:Bank:BoC</code>, <code>Assets:Bank</code>, <code>Assets</code> 。我的做法是原则上用现实世界里的最细分的账户映射 beancount 里的账户，结合账户的实际用途设置账户名。</p><h4 id=如何选择账户初始日期>如何选择账户初始日期？</h4><p>偷懒的话可以选择 1970-01-01。</p><p>我的做法是：Assets 类账户选择我开始使用 beancount 的日期，Liabilities、Expenses 账户用生日，Income 选择当前这份工作的日期。</p><h4 id=assets>Assets</h4><p>假设我在招商银行有两张储蓄卡，其中一张开通了朝朝盈的理财服务并且用于日常消费，另一张卡用于每月定额存款，积累资金用于凑购房首付，那么我会这样设置 Assets 账户(XXXX 是卡号末四位，下面同理)：</p><pre><code class=language-nil data-lang=nil>1970-01-01 open Assets:Bank:CMB:CardXXXX:Deposit CNY
1970-01-01 open Assets:Bank:CMB:CardXXXX:ZZY CNY</code></pre><p>对于存款卡，因为只用于特定用途，不会挪作他用，还有别的账户里也有存款用于同样的用途，比如政府的住房公积金，那么我这样设置账户：</p><pre><code class=language-nil data-lang=nil>1970-01-01 open Assets:Saving:HouseFund:Bank:CMB:CardXXXX:Deposit CNY
1970-01-01 open Assets:Saving:HouseFund:Goverment CNY</code></pre><h4 id=liabilities>Liabilities</h4><p>假设我在招商银行有一张银联信用卡，一张 Visa 信用卡；在交通银行有一张银联信用卡，一张 Vsia 信用卡。由于招商银行共享额度、合并账单、征信内只有一个账户；交通银行虽然也共享额度，但是拆分账单，每个账单要单独还款，并且在征信系统内一卡一账户，我这样设置账户：</p><pre><code class=language-nil data-lang=nil>1970-01-01 open Liabilities:CreditCards:CMB CNY
1970-01-01 open Liabilities:Creditcards:COMM:CardVisaXXXX CNY
1970-01-01 open Liabilities:Creditcards:COMM:CardUnionXXXX CNY</code></pre><p>这样既可以既可以对单个账户断言 balance，也可以对单个银行对断言 balance。</p><h4 id=income>Income</h4><p>工资收入可以设置账户 Income:CompanyName:Salary 就行, 如果有饭补、报销之类的，可以单写 Income:CompanyName:FoodSubsidy, Income:CompanyName:Reimbursement.
这里用 event 指令，可以记录下哪天加入公司，比如 <code>2018-01-01 event "入职 XX"</code> 。</p><h4 id=expenses>Expenses</h4><p>基本原则同上，我在 Expenses 分类下设置了如下几种账户：</p><ul><li><p>政府相关的：主要是五险一金、税之类。</p><pre><code class=language-nil data-lang=nil>1970-01-01 open Expenses:Government:Pension CNY
1970-01-01 open Expenses:Government:Unemployment CNY
1970-01-01 open Expenses:Government:MedicalCare CNY
1970-01-01 open Expenses:Government:IncomeTax CNY</code></pre></li><li><p>日常消费，按照衣食行分了几大类，可以包含交通、食物、下馆子、日用杂物、买书、订阅（软件、VPS之类）以及宠物的支出。基本都在三级以内，再通过交易的 <a href="https://docs.google.com/document/d/1wAMVrKIA2qtRGmoVDSUBJGmYZSygUaR0uOMW1GV3YE0/edit#heading=h.2xx3dcvvf0r8" rel=noreferrer target=_blank>tag</a> 标记消费的具体支出，比如食物相关的交易记录会打上这些 Tag：早餐、日常饮用水、饮料、零食等等，可以按需使用，最终在 fava 生成的网页里可以按照 tag 过滤查看。</p></li><li><p>住的消费相对固定，并且因为是在北京租房，也是一笔不小的支出，单独开设一类账户用来管理，建议使用当前住宿房屋的简称，比如：Expenses:Lofter0817:Rent, Expenses:Lofter0817:Utility。</p></li></ul><h4 id=equity>Equity</h4><p>目前我只设置了一个 Equity 账户 Equity:Opening-Balances，用来平衡初始资产、负债账户时的会计恒等式。也就是，我想往一个银行卡账户里添加 1000 元，并且想保持平衡，那么需要从某个账户减 1000 元，在初始化时，这个账户就是 Equity:Opening-Balances。一个示例：</p><pre><code class=language-nil data-lang=nil>1970-01-01 open Assets:Bank:CMB:CardXXXX CNY
1991-05-21 pad Assets:Bank:CMB:C6698 Equity:Opening-Balances
2018-10-17 balance Assets:Bank:CMB:C6698 11912.77 CNY</code></pre><h3 id=balance>Balance</h3><p>设置了账户之后，要把对应的现实账户的状态反应出来，需要用 <code>balance</code> 指令进行断言操作，用 <code>pad</code> 指令进行辅助。比如在设置账户的当时，银行卡内有存款 1000 元，可以在 <code>open</code> 账户那行之后添加变成下面的结构，注意 beancount 默认交易都在一天的开始发生，所以 balance 断言要写在第二天，表示截止到第二天零点的情况。</p><pre><code class=language-nil data-lang=nil>1970-01-01 open Assets:Bank:CMB:Card0817
1970-01-01 pad Assets:Bank:CMB:Card0817 Equity:Opening-Balances
1970-01-02 balance Assets:Bank:CMB:Card0817 1000 CNY</code></pre><p>其他账户依照此方法设置即可。</p><h2 id=导入数据>导入数据</h2><p>除了账户和 balance 断言， <code>.bean</code> 文件里大部分内容是一笔笔交易记录，一个笔交易在 beancount 里一般长这样：</p><pre><code class=language-nil data-lang=nil>2018-10-22 * &#34;描述&#34;
  card: &#34;CardXXXX&#34;
  date: 2018-10-21
  Liabilities:CreditCards:CMB  -1921.00 CNY
  Expenses:Other</code></pre><p>2018-10-22 是银行记帐日期，&#187;*&#187; 号表示交易确认无误，接着是交易描述；后两行是 metadata，可以用于过滤；接下来是交易涉及的账户，有减操作的账户，就有加操作的账户，这里 Expenses:Other 账户没有写加金额，是因为加操作只涉及这一个账户，beancount 会自行补齐数据。更详细的可以参考 <a href=https://docs.google.com/document/d/1wAMVrKIA2qtRGmoVDSUBJGmYZSygUaR0uOMW1GV3YE0/edit# rel=noreferrer target=_blank>Beancount Language Syntax</a> 。</p><p>每笔交易都这么手写一遍就太低效率了，还好 beancount 支持从导入第三方数据，前文提到的 <code>importers</code> 目录内就可以用来存放自定义的导入脚本，不过自带 csv 导入器就可以解决目前绝大部分需求。</p><h3 id=获取数据>获取数据</h3><p>目前国内部分银行提供 csv 各式的对账单，比如招商银行可以登录个人网银后找到对账单下载；也有银行不提供 csv、Excel 各式的对账单下载，可以尝试下面两个方法：</p><ul><li>如果银行提供网页版对账单，并且账单页面内容是 html table，可以使用 Chrome 插件<a href=https://chrome.google.com/webstore/detail/table-capture/iebpjdmgckacbodjpijphcplhebcmeop rel=noreferrer target=_blank> Table-Capture</a> 把页面里的 table 导出到 Google Spreadsheet，再导出为 csv;</li><li>银行应该都会提供 pdf 各式的对账单，可以尝试用 <a href=https://tabula.technology/ rel=noreferrer target=_blank>Tabula</a> 这个工具，从 pdf 文件里解析账单表格并导出;</li></ul><p>经过测试，以上两个方法能够搞定招商、交通、中信、浦发这四个银行账单。</p><h3 id=准备数据>准备数据</h3><p>获取到 csv 各式的数据后，需要做一些准备工作：</p><ul><li>去除文件里的奇怪的符号，比如交通银行的账单里会包含 <code>^M</code> 这个符号，用 <code>C-c C-m</code> 可以在终端里敲出这个字符；</li><li>金额改为只保留数字部分；</li><li>把文件编码转换为 utf-8: <code>iconv -f gbk -t UTF-8 file > file.utf-8</code> ；</li><li>转换文件的换行方式: <code>dos2unix file.utf-8</code> ；</li></ul><h3 id=import-配置>import 配置</h3><p>我的 import 配置文件 <code>yc.imoprt</code> 抹去敏感信息之后示例如下下方的代码。</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=ch>#!/usr/bin/env python</span>

<span class=kn>import</span> <span class=nn>os</span>
<span class=kn>import</span> <span class=nn>sys</span>

<span class=kn>import</span> <span class=nn>beancount.ingest.extract</span>
<span class=kn>from</span> <span class=nn>beancount.ingest.importers</span> <span class=kn>import</span> <span class=n>csv</span>

<span class=n>beancount</span><span class=o>.</span><span class=n>ingest</span><span class=o>.</span><span class=n>extract</span><span class=o>.</span><span class=n>HEADER</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>

<span class=n>CONFIG</span> <span class=o>=</span> <span class=p>[</span>
    <span class=c1># CMB Credit</span>
    <span class=n>csv</span><span class=o>.</span><span class=n>Importer</span><span class=p>(</span>
        <span class=p>{</span>
            <span class=n>csv</span><span class=o>.</span><span class=n>Col</span><span class=o>.</span><span class=n>DATE</span><span class=p>:</span> <span class=s1>&#39;记账日期&#39;</span><span class=p>,</span>
            <span class=n>csv</span><span class=o>.</span><span class=n>Col</span><span class=o>.</span><span class=n>TXN_DATE</span><span class=p>:</span> <span class=s1>&#39;交易日期&#39;</span><span class=p>,</span>
            <span class=n>csv</span><span class=o>.</span><span class=n>Col</span><span class=o>.</span><span class=n>NARRATION1</span><span class=p>:</span> <span class=s1>&#39;交易摘要&#39;</span><span class=p>,</span>
            <span class=n>csv</span><span class=o>.</span><span class=n>Col</span><span class=o>.</span><span class=n>AMOUNT_DEBIT</span><span class=p>:</span> <span class=s1>&#39;人民币金额&#39;</span><span class=p>,</span>
            <span class=n>csv</span><span class=o>.</span><span class=n>Col</span><span class=o>.</span><span class=n>LAST4</span><span class=p>:</span> <span class=s1>&#39;卡号后四位&#39;</span>
        <span class=p>},</span>
        <span class=n>account</span><span class=o>=</span><span class=s1>&#39;Liabilities:CreditCards:CMB&#39;</span><span class=p>,</span>
        <span class=n>currency</span><span class=o>=</span><span class=s1>&#39;CNY&#39;</span><span class=p>,</span>
        <span class=n>regexps</span><span class=o>=</span><span class=s1>&#39;</span><span class=se>\t</span><span class=s1>对账标志&#39;</span><span class=p>,</span>
        <span class=n>last4_map</span><span class=o>=</span><span class=p>{</span>
            <span class=s2>&#34;0000&#34;</span><span class=p>:</span> <span class=s2>&#34;招行 0000&#34;</span><span class=p>,</span>
        <span class=p>},</span>
        <span class=c1># categorizer=guess.guess2</span>
    <span class=p>),</span>
    <span class=c1># COMM Credit 0000</span>
    <span class=n>csv</span><span class=o>.</span><span class=n>Importer</span><span class=p>(</span>
        <span class=p>{</span>
            <span class=n>csv</span><span class=o>.</span><span class=n>Col</span><span class=o>.</span><span class=n>DATE</span><span class=p>:</span> <span class=s1>&#39;记账日期&#39;</span><span class=p>,</span>
            <span class=n>csv</span><span class=o>.</span><span class=n>Col</span><span class=o>.</span><span class=n>TXN_DATE</span><span class=p>:</span> <span class=s1>&#39;交易日期&#39;</span><span class=p>,</span>
            <span class=n>csv</span><span class=o>.</span><span class=n>Col</span><span class=o>.</span><span class=n>NARRATION1</span><span class=p>:</span> <span class=s1>&#39;交易说明&#39;</span><span class=p>,</span>
            <span class=n>csv</span><span class=o>.</span><span class=n>Col</span><span class=o>.</span><span class=n>AMOUNT_DEBIT</span><span class=p>:</span> <span class=s1>&#39;清算币种/金额&#39;</span><span class=p>,</span>
            <span class=n>csv</span><span class=o>.</span><span class=n>Col</span><span class=o>.</span><span class=n>LAST4</span><span class=p>:</span> <span class=s1>&#39;卡号末四位&#39;</span>
        <span class=p>},</span>
        <span class=n>account</span><span class=o>=</span><span class=s1>&#39;Liabilities:CreditCards:COMM:C0000&#39;</span><span class=p>,</span>
        <span class=n>currency</span><span class=o>=</span><span class=s1>&#39;CNY&#39;</span><span class=p>,</span>
        <span class=n>regexps</span><span class=o>=</span><span class=s1>&#39;交行0000&#39;</span><span class=p>,</span>
        <span class=n>skip_lines</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
        <span class=n>last4_map</span><span class=o>=</span><span class=p>{</span>
            <span class=s2>&#34;0000&#34;</span><span class=p>:</span> <span class=s2>&#34;交行 0000&#34;</span><span class=p>,</span>
        <span class=p>},</span>
        <span class=c1># categorizer=guess.guess2]</span>
    <span class=p>)</span>
<span class=p>]</span></code></pre></div><p>csv.Col.XXX 对应的是 csv 文件的 header，新加账户、账单的话对照修改就行。整体执行流程大约是，对于一个待导入文件：</p><ol><li>每个 importer 判断自己是否会处理这个文件，如果会处理，交给这个 imoprter 处理导入，并不再往下判断；csv importer 是通过 regexps 参数里指定的正则匹配整个文件内容，看能否匹配上。</li><li>由于交行（其他银行也有可能）一卡一账单，账单的头部都一样，我在 csv header 下面插入一行 “交行0000”（0000是卡号末四位）来标记此文件是哪张卡的账单，应该对应到哪个账户，再配置 skip_lines 参数，在实际导入的时候跳过这一行。</li><li>last4_map 会匹配卡号末四位，生成 <code>card: 交行 0000</code> 写到交易的 metadata 里。</li></ol><h3 id=执行导入>执行导入</h3><p>把准备好的账单文件放到上面提及的 documents.tmp 目录里，再执行:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>bean-extract yc.import <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>/documents.tmp &gt; tmp.bean</code></pre></div><p>我习惯先把记录先导出到临时账簿文件里，检查一下交易记录、修正一部分交易描述、添加 Expenses 账户，再导出到总账簿文件里。</p><p>添加 Expenses 账户这一步可以尝试自定义 categorizer 来实现自动化，比如交易描述里包含“饿了么”自动归到 Expenses:Food 账户里。我还没有实现这部分，可以参考这个 <a href=https://bitbucket.org/blais/beancount/pull-requests/24/improve-ingestimporterscsv/diff rel=noreferrer target=_blank>Pull Request</a>。</p><p>导入完成后，再执行下面的命令，把原文件归档到 documents 目录里。</p><pre><code class=language-nil data-lang=nil>bean-file yc.import ${PWD}/documents.tmp -o documents</code></pre><h2 id=我的工作流>我的工作流</h2><p>目前我的大部分支出会落到信用卡里，少量走借记卡，极少现金。信用卡出账单日也统一到一两天之内。整体工作流程大概是这样：</p><ol><li>每月最后一个账单出来后，整理好账单文件，用 bean-extract 导入账单；</li><li>对 Liabilities 账户进行 balance 断言；</li><li>在还款日前还款后，对 Assets 账户断言；</li><li>发薪日再次对各类账户进行一次断言；</li><li>每月检查个账户的错误情况，fava 生成的网页上有一个 Errors 子页面；回顾支出情况；</li></ol><h2 id=总结>总结</h2><p>开始说要记账、规划自己的财务状况有半年多了，断断续续用过几款 App，都没有能完全坚持下来，直到在 wzyboy 的博客上看到 beancount 工具的安利，有如开挂一样，个人的财务状况从整体到细节都能看的清楚，也是我喜欢的纯文本工具，信息不会留在第三方、方便各种编辑、导入导出、备份。</p><p>在入门上手期间，通过邮件向 <a href=https://wzyboy.im/ rel=noreferrer target=_blank>wzyboy</a> 请教了不少疑问，都得到了细致及时的解答，表示感谢。</p><hr width=100% id=EOF><p style=color:#777>最后修改于 2020-05-17</p></div><div class=post-related></div></div><nav class=post-pagination><a class=newer-posts href=https://yuchi.me/post/deploy-kubernetes-with-kubeadm/>下回<br>用 kubeadm 部署简易 kubernetes 集群</a>
<a class=older-posts>上回<br>这是最旧的文章了。</a></nav><div class=post-comment-wrapper><div class=comments><vue-disqus shortname=chis-journal></vue-disqus></div><noscript><noscript>请开启 JavaScript 以便使用评论服务。</noscript></noscript><a href=https://disqus.com/ class=dsq-brlink>Comments powered by <span class=logo-disqus>Disqus</span></a></div><div class=post-footer-tags><i class=material-icons>label</i>
<a href=/tags/beancount>beancount</a>
&nbsp;
<a href=/tags/%E8%AE%B0%E8%B4%A6>记账</a>
&nbsp;</div></div></div></div></div><div id=single-column-footer>Written with <a target=_blank rel="noreferrer noopener" href=https://www.gnu.org/software/emacs/>Emacs</a> and <a target=_blank rel="noreferrer noopener" href=https://orgmode.org/>Org-mode</a>.<br>Rendered by <a target=_blank rel="noreferrer noopener" href=https://gohugo.io>Hugo</a>.<br>Theme <a target=_blank rel="noreferrer noopener" href=https://github.com/amazingrise/hugo-theme-diary>Diary</a>(Modified).<br>Converted by <a target=_blank rel="noreferrer noopener" href=https://ox-hugo.scripter.co/>ox-hugo</a>.<br>&copy;
2020 Chi's Journal</div></div><script>let app;app=new Vue({el:'#app',data:{scrollY:0,navOpacity:0,isDrawerOpen:false,mounted:false,isDarkMode:false},methods:{sgn(t,x){let k=1./(1.-2*t);if(x<=t)return 0;else if(x>=1-t)return 1;else{return k*(x-t);}},handleScroll(){this.scrollY=window.scrollY;this.navOpacity=this.sgn(.0,Math.min(1,Math.max(0,window.scrollY/(this.pageHeadHeight()-this.navBarHeight()*0.8))));const{navBar,navBackground,navTitle,extraContainer,streamContainer}=this.$refs;if(this.navOpacity>=1){navBackground.style.opacity=1;navTitle.style.opacity=1;}else{navBackground.style.opacity=0;navTitle.style.opacity=0;}},handleResize(){const{navBar,navBackground,navTitle,extraContainer,streamContainer}=this.$refs;extraContainer.style.left=(streamContainer.offsetWidth-extraContainer.offsetWidth)+'px';},navBarHeight(){return this.$refs.navBar.offsetHeight;},pageHeadHeight(){return this.$refs.pageHead.offsetHeight;},toggleDrawer(){this.isDrawerOpen=!this.isDrawerOpen;document.getElementsByTagName('html')[0].style.overflow=this.isDrawerOpen?'hidden':'unset';},closeDrawer(){this.isDrawerOpen=false;document.getElementsByTagName('html')[0].style.overflow=this.isDrawerOpen?'hidden':'unset';},toggleDarkMode(){this.isDarkMode=!this.isDarkMode;if(this.isDarkMode==true){document.cookie="night=1;path=/";document.body.classList.add("night");}else{document.cookie="night=0;path=/";document.body.classList.remove("night");}}},created(){window.addEventListener('scroll',this.handleScroll);window.addEventListener('resize',this.handleResize);window._nonDesktop=function(){let check=false;(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check=true;})(navigator.userAgent||navigator.vendor||window.opera);return check;};var night=document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/,"$1");if(night==""){if(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches){}}else{if(night=="1"){this.toggleDarkMode();}}},mounted(){this.handleScroll();this.handleResize();this.mounted=true;},destroyed(){window.removeEventListener('scroll',this.handleScroll);window.removeEventListener('resize',this.handleResize);}});</script><script src=https://yuchi.me//js/journal.js></script><script src=/vendor/js/load-photoswipe.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin=anonymous></script><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div></body></html>