<!doctype html><html><head><title>使用 docker 部署一个生产环境可用的 ELK 集群</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=keywords content="elasticsearch,docker,tls"><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-164155675-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-164155675-1');</script><script src=/vendor/js/jquery.min.js></script><script src=/vendor/js/popper.min.js></script><script src=/vendor/js/bootstrap.min.js></script><script src=/vendor/js/smooth-scroll.polyfills.min.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><script src=/vendor/js/vue.min.js></script><link rel=icon href=/favicon.png><link rel=stylesheet href=https://yuchi.me/zh.journal.min.61c96af618f6e0e038e54359d29edfbb60c5d7a9e9327866126dbdeb69ce6253.css integrity="sha256-Yclq9hj24OA45UNZ0p7fu2DF16npMnhmEm2962nOYlM=" media=screen><link rel=stylesheet href=https://yuchi.me/zh.darkmode.min.947ee7777df04387f743701f79acd617dc8275294e917b17598964f7eef70ca8.css integrity="sha256-lH7nd33wQ4f3Q3AfeazWF9yCdSlOkXsXWYlk9+73DKg=" media=screen><script src=https://yuchi.me//js/loadCSS.js></script><script>loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");</script><script src=https://yuchi.me//js/toc-collapse.js></script><script src=https://cdn.jsdelivr.net/npm/vue-disqus@3/dist/vue-disqus.js></script></head><body><div id=app><div ref=sideContainer class=side-container><a class="a-block nav-head false" href=/><div class=nav-title>Chi's Journal</div><div class=nav-subtitle>- Ecclesiastes 1.11</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/post/>归档</a>
<a class="a-block nav-link-item false" href=/tags/>标签</a><div class=nav-link-item></div><div class=nav-link-item><a href=https://twitter.com/wych42 target=_blank><i title=Twitter class="fab fa-twitter"></i></a><a href=https://yuchi.me//index.xml target=_blank><i title=Feed class="fas fa-rss"></i></a></div></div><div class=nav-footer>Written with <a target=_blank rel="noreferrer noopener" href=https://www.gnu.org/software/emacs/>Emacs</a> and <a target=_blank rel="noreferrer noopener" href=https://orgmode.org/>Org-mode</a>.<br>Rendered by <a target=_blank rel="noreferrer noopener" href=https://gohugo.io>Hugo</a>.<br>Theme <a target=_blank rel="noreferrer noopener" href=https://github.com/amazingrise/hugo-theme-diary>Diary</a>(Modified).<br>Converted by <a target=_blank rel="noreferrer noopener" href=https://ox-hugo.scripter.co/>ox-hugo</a>.<br>&copy;
2020 Chi's Journal</div></div><div ref=extraContainer class=extra-container><div class="toc animated-visibility"><div class=toc-content><center>- 目录 -</center><ul><ul class=collapse data-toggle=collapse><li><a href=#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c onclick="collapseOthers(`#准备工作-nav`)" id=准备工作-nav>准备工作</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e7%86%9f%e6%82%89-docker-%e5%92%8c-docker-elk-%e9%a1%b9%e7%9b%ae onclick="collapseOthers(`#熟悉-docker-和-docker-elk-项目-nav`)" id=熟悉-docker-和-docker-elk-项目-nav>熟悉 docker 和 docker-elk 项目</a></li><li><a href=#%e8%8a%82%e7%82%b9%e8%a7%84%e5%88%92 onclick="collapseOthers(`#节点规划-nav`)" id=节点规划-nav>节点规划</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e8%8a%82%e7%82%b9 onclick="collapseOthers(`#节点-nav`)" id=节点-nav>节点</a></li><li><a href=#%e7%ab%af%e5%8f%a3 onclick="collapseOthers(`#端口-nav`)" id=端口-nav>端口</a></li><li><a href=#%e6%95%b0%e6%8d%ae%e7%9b%ae%e5%bd%95 onclick="collapseOthers(`#数据目录-nav`)" id=数据目录-nav>数据目录</a></li></ul></ul><li><a href=#%e5%87%86%e5%a4%87%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#准备配置-nav`)" id=准备配置-nav>准备配置</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e5%87%86%e5%a4%87%e8%87%aa%e7%ad%be%e5%90%8d%e8%af%81%e4%b9%a6 onclick="collapseOthers(`#准备自签名证书-nav`)" id=准备自签名证书-nav>准备自签名证书</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 onclick="collapseOthers(`#修改配置文件-nav`)" id=修改配置文件-nav>修改配置文件</a></li><li><a href=#%e7%94%9f%e6%88%90%e8%af%81%e4%b9%a6 onclick="collapseOthers(`#生成证书-nav`)" id=生成证书-nav>生成证书</a></li></ul><li><a href=#%e6%9b%b4%e6%96%b0-docker-compose-%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#更新-docker-compose-配置-nav`)" id=更新-docker-compose-配置-nav>更新 docker-compose 配置</a></li><ul class=collapse data-toggle=collapse><li><a href=#volume-%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#volume-配置-nav`)" id=volume-配置-nav>volume 配置</a></li><li><a href=#%e8%af%81%e4%b9%a6%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#证书配置-nav`)" id=证书配置-nav>证书配置</a></li><li><a href=#%e8%8a%82%e7%82%b9%e5%92%8c%e9%9b%86%e7%be%a4%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#节点和集群配置-nav`)" id=节点和集群配置-nav>节点和集群配置</a></li><li><a href=#%e8%b0%83%e6%95%b4%e7%b3%bb%e7%bb%9f%e5%8f%82%e6%95%b0 onclick="collapseOthers(`#调整系统参数-nav`)" id=调整系统参数-nav>调整系统参数</a></li><li><a href=#%e5%90%8c%e6%ad%a5%e9%85%8d%e7%bd%ae%e5%88%b0%e5%90%84%e4%b8%aa%e8%8a%82%e7%82%b9 onclick="collapseOthers(`#同步配置到各个节点-nav`)" id=同步配置到各个节点-nav>同步配置到各个节点</a></li></ul></ul><li><a href=#%e5%90%af%e5%8a%a8%e9%9b%86%e7%be%a4 onclick="collapseOthers(`#启动集群-nav`)" id=启动集群-nav>启动集群</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e5%90%af%e5%8a%a8-master-%e8%8a%82%e7%82%b9 onclick="collapseOthers(`#启动-master-节点-nav`)" id=启动-master-节点-nav>启动 master 节点</a></li><li><a href=#%e5%90%af%e5%8a%a8%e6%95%b0%e6%8d%ae%e8%8a%82%e7%82%b9--%e4%bb%8e%e8%8a%82%e7%82%b9 onclick="collapseOthers(`#启动数据节点--从节点-nav`)" id=启动数据节点--从节点-nav>启动数据节点(从节点)</a></li><li><a href=#%e9%87%8d%e7%bd%ae%e5%86%85%e5%bb%ba%e8%b4%a6%e6%88%b7%e5%af%86%e7%a0%81 onclick="collapseOthers(`#重置内建账户密码-nav`)" id=重置内建账户密码-nav>重置内建账户密码</a></li><li><a href=#%e5%90%af%e5%8a%a8-kibana onclick="collapseOthers(`#启动-kibana-nav`)" id=启动-kibana-nav>启动 kibana</a></li><li><a href=#%e5%90%af%e5%8a%a8-logstash onclick="collapseOthers(`#启动-logstash-nav`)" id=启动-logstash-nav>启动 logstash</a></li><li><a href=#%e6%b3%a8%e5%85%a5%e6%b5%8b%e8%af%95%e6%95%b0%e6%8d%ae onclick="collapseOthers(`#注入测试数据-nav`)" id=注入测试数据-nav>注入测试数据</a></li></ul><li><a href=#%e5%ae%8c%e6%95%b4%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#完整配置-nav`)" id=完整配置-nav>完整配置</a></li></ul></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a class=pagination-action v-on:click=toggleDarkMode><i class="material-icons pagination-action-icon" v-if=isDarkMode>brightness_4</i>
<i class="material-icons pagination-action-icon" v-else=isDarkMode>brightness_7</i></a></div></div><div class=single-column-drawer-container ref=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/post/>归档</a>
<a class="a-block drawer-menu-item false" href=/tags/>标签</a><div class="a-block drawer-menu-item false"></div><div class="a-block drawer-menu-item false"><a href=https://twitter.com/wych42 target=_blank><i title=Twitter class="fab fa-twitter"></i></a><a href=https://yuchi.me//index.xml target=_blank><i title=Feed class="fas fa-rss"></i></a></div><div class=toc><div class=toc-content><center>- 目录 -</center><ul><ul class=collapse data-toggle=collapse><li><a href=#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c onclick="collapseOthers(`#准备工作-nav`)" id=准备工作-nav>准备工作</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e7%86%9f%e6%82%89-docker-%e5%92%8c-docker-elk-%e9%a1%b9%e7%9b%ae onclick="collapseOthers(`#熟悉-docker-和-docker-elk-项目-nav`)" id=熟悉-docker-和-docker-elk-项目-nav>熟悉 docker 和 docker-elk 项目</a></li><li><a href=#%e8%8a%82%e7%82%b9%e8%a7%84%e5%88%92 onclick="collapseOthers(`#节点规划-nav`)" id=节点规划-nav>节点规划</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e8%8a%82%e7%82%b9 onclick="collapseOthers(`#节点-nav`)" id=节点-nav>节点</a></li><li><a href=#%e7%ab%af%e5%8f%a3 onclick="collapseOthers(`#端口-nav`)" id=端口-nav>端口</a></li><li><a href=#%e6%95%b0%e6%8d%ae%e7%9b%ae%e5%bd%95 onclick="collapseOthers(`#数据目录-nav`)" id=数据目录-nav>数据目录</a></li></ul></ul><li><a href=#%e5%87%86%e5%a4%87%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#准备配置-nav`)" id=准备配置-nav>准备配置</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e5%87%86%e5%a4%87%e8%87%aa%e7%ad%be%e5%90%8d%e8%af%81%e4%b9%a6 onclick="collapseOthers(`#准备自签名证书-nav`)" id=准备自签名证书-nav>准备自签名证书</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 onclick="collapseOthers(`#修改配置文件-nav`)" id=修改配置文件-nav>修改配置文件</a></li><li><a href=#%e7%94%9f%e6%88%90%e8%af%81%e4%b9%a6 onclick="collapseOthers(`#生成证书-nav`)" id=生成证书-nav>生成证书</a></li></ul><li><a href=#%e6%9b%b4%e6%96%b0-docker-compose-%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#更新-docker-compose-配置-nav`)" id=更新-docker-compose-配置-nav>更新 docker-compose 配置</a></li><ul class=collapse data-toggle=collapse><li><a href=#volume-%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#volume-配置-nav`)" id=volume-配置-nav>volume 配置</a></li><li><a href=#%e8%af%81%e4%b9%a6%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#证书配置-nav`)" id=证书配置-nav>证书配置</a></li><li><a href=#%e8%8a%82%e7%82%b9%e5%92%8c%e9%9b%86%e7%be%a4%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#节点和集群配置-nav`)" id=节点和集群配置-nav>节点和集群配置</a></li><li><a href=#%e8%b0%83%e6%95%b4%e7%b3%bb%e7%bb%9f%e5%8f%82%e6%95%b0 onclick="collapseOthers(`#调整系统参数-nav`)" id=调整系统参数-nav>调整系统参数</a></li><li><a href=#%e5%90%8c%e6%ad%a5%e9%85%8d%e7%bd%ae%e5%88%b0%e5%90%84%e4%b8%aa%e8%8a%82%e7%82%b9 onclick="collapseOthers(`#同步配置到各个节点-nav`)" id=同步配置到各个节点-nav>同步配置到各个节点</a></li></ul></ul><li><a href=#%e5%90%af%e5%8a%a8%e9%9b%86%e7%be%a4 onclick="collapseOthers(`#启动集群-nav`)" id=启动集群-nav>启动集群</a></li><ul class=collapse data-toggle=collapse><li><a href=#%e5%90%af%e5%8a%a8-master-%e8%8a%82%e7%82%b9 onclick="collapseOthers(`#启动-master-节点-nav`)" id=启动-master-节点-nav>启动 master 节点</a></li><li><a href=#%e5%90%af%e5%8a%a8%e6%95%b0%e6%8d%ae%e8%8a%82%e7%82%b9--%e4%bb%8e%e8%8a%82%e7%82%b9 onclick="collapseOthers(`#启动数据节点--从节点-nav`)" id=启动数据节点--从节点-nav>启动数据节点(从节点)</a></li><li><a href=#%e9%87%8d%e7%bd%ae%e5%86%85%e5%bb%ba%e8%b4%a6%e6%88%b7%e5%af%86%e7%a0%81 onclick="collapseOthers(`#重置内建账户密码-nav`)" id=重置内建账户密码-nav>重置内建账户密码</a></li><li><a href=#%e5%90%af%e5%8a%a8-kibana onclick="collapseOthers(`#启动-kibana-nav`)" id=启动-kibana-nav>启动 kibana</a></li><li><a href=#%e5%90%af%e5%8a%a8-logstash onclick="collapseOthers(`#启动-logstash-nav`)" id=启动-logstash-nav>启动 logstash</a></li><li><a href=#%e6%b3%a8%e5%85%a5%e6%b5%8b%e8%af%95%e6%95%b0%e6%8d%ae onclick="collapseOthers(`#注入测试数据-nav`)" id=注入测试数据-nav>注入测试数据</a></li></ul><li><a href=#%e5%ae%8c%e6%95%b4%e9%85%8d%e7%bd%ae onclick="collapseOthers(`#完整配置-nav`)" id=完整配置-nav>完整配置</a></li></ul></div></div></div></div></div><transition name=fade><div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav ref=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div ref=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a ref=navTitle class=navbar-brand href=https://yuchi.me/>Chi's Journal</a>
<button type=button class=nav-darkmode-toggle v-on:click=toggleDarkMode>
<i class=material-icons v-if=isDarkMode>brightness_4</i>
<i class=material-icons v-else=isDarkMode>brightness_7</i></button></div></nav><div class=single-column-header-container ref=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://yuchi.me/><div class=single-column-header-title>Chi's Journal</div><div class=single-column-header-subtitle>- Ecclesiastes 1.11</div></a></div><div id=content><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper style=background-image:url(https://yuchi.me/images/featured/elasticsearch-logo.png)><div class=post-title>使用 docker 部署一个生产环境可用的 ELK 集群<div class=post-meta><time itemprop=datePublished>2020-05-27 22:58</time>
<i class=material-icons>folder</i>
<a href=/categories/>[Post]</a>
&nbsp;
<i class=material-icons>label</i>
<a href=/tags/elasticsearch>elasticsearch</a>
&nbsp;
<a href=/tags/docker>docker</a>
&nbsp;
<a href=/tags/tls>tls</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><p>近日在网上冲浪的时候，看到 soulteary 同学撰写的 <a href=https://soulteary.com/2020/05/04/use-docker-to-build-elk-environment.html rel=noreferrer target=_blank>使用 Docker 搭建 ELK 环境</a>，发现文中提及的 <a href=https://github.com/deviantony/docker-elk rel=noreferrer target=_blank>docker-elk</a> 项目.
与我自行维护用于部署生产环境 ELK 集群的项目, 在代码结构上十分相似。便将本地项目迁移到 docker-elk, 并向上游项目发了一个针对开启 TLS 的 <a href=https://github.com/deviantony/docker-elk/pulls rel=noreferrer target=_blank>Patch</a>.
顺便针对在生产环境部署多主机节点集群、开启 TLS 加密通信做一个详细的介绍。</p><p>本文将会涉及到：</p><ul><li>基于 <a href=https://github.com/deviantony/docker-elk rel=noreferrer target=_blank>docker-elk</a> 项目进行部署操作，避免重复造轮子</li><li>用三个主机节点组成 elasticsearch 集群</li><li>集群内部使用自签名的 TLS 证书通信</li><li>kibana, logstash 与 elasticsearch 集群的通信开启 TLS 加密</li></ul><h2 id=准备工作>准备工作</h2><h3 id=熟悉-docker-和-docker-elk-项目>熟悉 docker 和 docker-elk 项目</h3><p>后续假设读者已经熟悉:</p><ul><li>docker/docker-compose 的基本用法</li><li>docker-elk 项目的用法</li><li>elasticsearch 的基本概念</li></ul><p>如果还不熟悉，可以跟着开头提及的文章操作一次。</p><h3 id=节点规划>节点规划</h3><h4 id=节点>节点</h4><p>本文将使用三个主机节点部署 elasticsearch 集群, 三个节点在同一个内网中，并且可以互相连接:</p><ul><li>节点A: 主机名: <code>es01.yuchi.lab</code>, IP: <code>10.11.12.13</code></li><li>节点B: 主机名: <code>es02.yuchi.lab</code>, IP: <code>10.11.12.14</code></li><li>节点C: 主机名: <code>es03.yuchi.lab</code>, IP: <code>10.11.12.15</code></li></ul><p>备注:</p><ul><li>节点A作为 master 节点使用</li><li>主机名将作为环境变量 NODE_NAME，在后文使用</li></ul><h4 id=端口>端口</h4><p>所有 elasticsearch 实例，在主机上暴露的端口修改为:</p><ul><li>http: 9220(默认 9200)</li><li>tcp: 9320(默认 9300)</li></ul><p>以方便在已经部署了 elasticsearch 示例的设备上测试。</p><h4 id=数据目录>数据目录</h4><ul><li>es 数据存储在 <code>/data/es/${NODE_NAME}-data/</code> 目录</li><li>es 日志存储在 <code>/data/es/${NODE_NAME}-log/</code> 目录</li></ul><p>可以在各个节点上保存并执行下面的脚本:</p><p><a id=code-snippet--prepare-dir.sh></a></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span>
<span class=k>if</span> <span class=o>[[</span> <span class=s2>&#34;x</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;x&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
    <span class=nb>echo</span> <span class=s2>&#34;need param as NODE_NAME&#34;</span>
    <span class=nb>exit</span> <span class=m>1</span>
<span class=k>fi</span>
<span class=nb>export</span> <span class=nv>NODE_NAME</span><span class=o>=</span><span class=nv>$1</span>

<span class=nv>dataDir</span><span class=o>=</span><span class=s2>&#34;/data/es/</span><span class=si>${</span><span class=nv>NODE_NAME</span><span class=si>}</span><span class=s2>-data/&#34;</span>
<span class=nv>logDir</span><span class=o>=</span><span class=s2>&#34;/data/es/</span><span class=si>${</span><span class=nv>NODE_NAME</span><span class=si>}</span><span class=s2>-log/&#34;</span>

sudo mkdir <span class=nv>$dataDir</span> -p
sudo mkdir <span class=nv>$logDir</span> -p

sudo chmod g+rwx <span class=nv>$dataDir</span>
sudo chmod g+rwx <span class=nv>$logDir</span>

sudo chgrp <span class=m>1000</span> <span class=nv>$dataDir</span>
sudo chgrp <span class=m>1000</span> <span class=nv>$logDir</span></code></pre></div><p>然后执行(替换 NODE_NAME 为真实的主机名):</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo bash prepare_dir.sh NODE_NAME</code></pre></div><h2 id=准备配置>准备配置</h2><h3 id=准备自签名证书>准备自签名证书</h3><p>生成证书在本地执行.</p><div class="shortcode-notice warning"><div class="shortcode-notice-title warning">warning</div><p>不要将证书文件添加到 git 仓库中。</p><p></div></p><h4 id=修改配置文件>修改配置文件</h4><p>进入本地的 docker-elk 目录，添加下面的文件:</p><p><a id=code-snippet--create-cert.yml></a></p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.2&#34;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>services</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>create_ca</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>container_name</span><span class=p>:</span><span class=w> </span>create_ca<span class=w>
</span><span class=w>    </span><span class=k>image</span><span class=p>:</span><span class=w> </span>docker.elastic.co/elasticsearch/elasticsearch<span class=p>:</span>${ELK_VERSION}<span class=w>
</span><span class=w>    </span><span class=k>command</span><span class=p>:</span><span class=w> </span><span class=sd>&gt;
</span><span class=sd>      bash -c &#39;</span><span class=w>
</span><span class=w>        </span>yum<span class=w> </span>install<span class=w> </span>-y<span class=w> </span>-q<span class=w> </span>-e<span class=w> </span><span class=m>0</span><span class=w> </span>unzip;<span class=w>
</span><span class=w>        </span>if<span class=w> </span><span class=p>[[</span><span class=w> </span>!<span class=w> </span>-f<span class=w> </span>/certs/ca.zip<span class=w> </span><span class=p>]]</span>;<span class=w> </span>then<span class=w>
</span><span class=w>          </span>bin/elasticsearch-certutil<span class=w> </span>ca<span class=w> </span>--ca-dn<span class=w> </span>${CA_DN}<span class=w> </span>--days<span class=w> </span>${CA_DAYS}<span class=w> </span>--pass<span class=w> </span>${CA_PASSWORD}<span class=w> </span>--pem<span class=w> </span>--out<span class=w> </span>/certs/ca.zip;<span class=w>
</span><span class=w>          </span>unzip<span class=w> </span>/certs/ca.zip<span class=w> </span>-d<span class=w> </span>/certs;<span class=w>
</span><span class=w>        </span>fi;<span class=w>
</span><span class=w>        </span>chown<span class=w> </span>-R<span class=w> </span><span class=m>1000</span><span class=p>:</span><span class=m>0</span><span class=w> </span>/certs<span class=w>
</span><span class=w>      </span><span class=s1>&#39;
</span><span class=s1>    user: &#34;0&#34;
</span><span class=s1>    working_dir: /usr/share/elasticsearch
</span><span class=s1>    volumes:
</span><span class=s1>      [
</span><span class=s1>        &#34;./tls/certs:/certs&#34;,
</span><span class=s1>        &#34;./tls:/usr/share/elasticsearch/config/certificates&#34;,
</span><span class=s1>      ]
</span><span class=s1>
</span><span class=s1>  create_certs:
</span><span class=s1>    container_name: create_certs
</span><span class=s1>    image: docker.elastic.co/elasticsearch/elasticsearch:${ELK_VERSION}
</span><span class=s1>    command: &gt;
</span><span class=s1>      bash -c &#39;</span><span class=w>
</span><span class=w>        </span>yum<span class=w> </span>install<span class=w> </span>-y<span class=w> </span>-q<span class=w> </span>-e<span class=w> </span><span class=m>0</span><span class=w> </span>unzip;<span class=w>
</span><span class=w>        </span>if<span class=w> </span><span class=p>[[</span><span class=w> </span>!<span class=w> </span>-f<span class=w> </span>/certs/bundle.zip<span class=w> </span><span class=p>]]</span>;<span class=w> </span>then<span class=w>
</span><span class=w>          </span>bin/elasticsearch-certutil<span class=w> </span>cert<span class=w> </span>--ca-cert<span class=w> </span>/certs/ca/ca.crt<span class=w> </span>--ca-key<span class=w> </span>/certs/ca/ca.key<span class=w> </span>--ca-pass<span class=w> </span>${CA_PASSWORD}<span class=w> </span>--pem<span class=w> </span>--in<span class=w> </span>config/certificates/instances.yml<span class=w> </span>-out<span class=w> </span>/certs/bundle.zip;<span class=w>
</span><span class=w>          </span>unzip<span class=w> </span>/certs/bundle.zip<span class=w> </span>-d<span class=w> </span>/certs;<span class=w>
</span><span class=w>        </span>fi;<span class=w>
</span><span class=w>        </span>chown<span class=w> </span>-R<span class=w> </span><span class=m>1000</span><span class=p>:</span><span class=m>0</span><span class=w> </span>/certs<span class=w>
</span><span class=w>      </span>&#39;<span class=w>
</span><span class=w>    </span><span class=k>user</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0&#34;</span><span class=w>
</span><span class=w>    </span><span class=k>working_dir</span><span class=p>:</span><span class=w> </span>/usr/share/elasticsearch<span class=w>
</span><span class=w>    </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=p>[</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;./tls/certs:/certs&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;./tls:/usr/share/elasticsearch/config/certificates&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>      </span><span class=p>]</span></code></pre></div><p><a id=code-snippet--tls-instances.yml></a></p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>instances</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>es01.yuchi.lab<span class=w>
</span><span class=w>    </span><span class=k>dns</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- es01.yuchi.lab<span class=w>
</span><span class=w>      </span>- localhost<span class=w>
</span><span class=w>      </span>- es01<span class=w>
</span><span class=w>    </span><span class=k>ip</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=m>127.0.0.1</span><span class=w>
</span><span class=w>      </span>- <span class=m>10.11.12.13</span><span class=w>
</span><span class=w>  </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>es02.yuchi.lab<span class=w>
</span><span class=w>    </span><span class=k>dns</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- es02.yuchi.lab<span class=w>
</span><span class=w>      </span>- localhost<span class=w>
</span><span class=w>      </span>- es02<span class=w>
</span><span class=w>    </span><span class=k>ip</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=m>127.0.0.1</span><span class=w>
</span><span class=w>      </span>- <span class=m>10.11.12.14</span><span class=w>
</span><span class=w>  </span>- <span class=k>name</span><span class=p>:</span><span class=w> </span>es03.yuchi.lab<span class=w>
</span><span class=w>    </span><span class=k>dns</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- es03.yuchi.lab<span class=w>
</span><span class=w>      </span>- localhost<span class=w>
</span><span class=w>      </span>- es03<span class=w>
</span><span class=w>    </span><span class=k>ip</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=m>127.0.0.1</span><span class=w>
</span><span class=w>      </span>- <span class=m>10.11.12.15</span></code></pre></div><p>在 .env 文件中添加 CA 证书相关的信息:</p><div class=highlight><pre class=chroma><code class=language-plaintext data-lang=plaintext># self-sign tls
CA_PASSWORD=ChangeMe
CA_DN=&#34;CN=Elastic Certificate Tool Autogenerated CA&#34;
CA_DAYS=3650</code></pre></div><h4 id=生成证书>生成证书</h4><p>先执行命令生成 CA:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker-compose -f create_cert.yml run --rm create_ca</code></pre></div><p>会在 <code>tls/certs/</code> 目录下生成 CA 文件：</p><div class=highlight><pre class=chroma><code class=language-plaintext data-lang=plaintext>tls/certs/
├── ca
│   ├── ca.crt
│   └── ca.key
├── ca.zip</code></pre></div><p>再使用 <code>tls/instances.yml</code> 文件生成每个节点的证书:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker-compose -f create_cert.yml run --rm create_certs</code></pre></div><p>最终 <code>tls/certs/</code> 目录里的文件结构如下:</p><div class=highlight><pre class=chroma><code class=language-plaintext data-lang=plaintext>tls/certs/
├── bundle.zip
├── ca
│   ├── ca.crt
│   └── ca.key
├── ca.zip
├── es01.yuchi.lab
│   ├── es01.yuchi.lab.crt
│   └── es01.yuchi.lab.key
├── es02.yuchi.lab
│   ├── es02.yuchi.lab.crt
│   └── es02.yuchi.lab.key
└── es03.yuchi.lab
    ├── es03.yuchi.lab.crt
    └── es03.yuchi.lab.key</code></pre></div><h3 id=更新-docker-compose-配置>更新 docker-compose 配置</h3><h4 id=volume-配置>volume 配置</h4><p>如开头所说，我们会将数据和日志保存在主机上的 <code>/data/es/${NODE_NAME}-{data,log}</code> 目录中，需要更新 <code>docker-compose.yml</code> 中的 <code>volumes</code> 部分为:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>esdata01</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>driver</span><span class=p>:</span><span class=w> </span>local<span class=w>
</span><span class=w>    </span><span class=k>driver_opts</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>type</span><span class=p>:</span><span class=w> </span>none<span class=w>
</span><span class=w>      </span><span class=k>o</span><span class=p>:</span><span class=w> </span>bind<span class=w>
</span><span class=w>      </span><span class=k>device</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/data/es/${NODE_NAME}-data/&#39;</span><span class=w>
</span><span class=w>  </span><span class=k>eslog01</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>driver</span><span class=p>:</span><span class=w> </span>local<span class=w>
</span><span class=w>    </span><span class=k>driver_opts</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>type</span><span class=p>:</span><span class=w> </span>none<span class=w>
</span><span class=w>      </span><span class=k>o</span><span class=p>:</span><span class=w> </span>bind<span class=w>
</span><span class=w>      </span><span class=k>device</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/data/es/${NODE_NAME}-log/&#39;</span></code></pre></div><p>在 <code>services.elasticsearch.volumes</code> 中添加配置，高亮的配置在原文件中存在，修改即可:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>services</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>elasticsearch</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>...<span class=w>
</span><span class=w>    </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=hl><span class=w>      </span>- <span class=k>type</span><span class=p>:</span><span class=w> </span>volume<span class=w>
</span></span><span class=hl><span class=w>        </span><span class=k>source</span><span class=p>:</span><span class=w> </span>esdata01<span class=w>
</span></span><span class=hl><span class=w>        </span><span class=k>target</span><span class=p>:</span><span class=w> </span>/usr/share/elasticsearch/data<span class=w>
</span></span><span class=w>      </span>- <span class=k>type</span><span class=p>:</span><span class=w> </span>volume<span class=w>
</span><span class=w>        </span><span class=k>source</span><span class=p>:</span><span class=w> </span>eslog01<span class=w>
</span><span class=w>        </span><span class=k>target</span><span class=p>:</span><span class=w> </span>/usr/share/elasticsearch/logs</code></pre></div><h4 id=证书配置>证书配置</h4><p>在 <code>.env</code> 文件中添加变量，设置容器内的证书路径(让 docker-compose 显得更整洁):</p><div class=highlight><pre class=chroma><code class=language-plaintext data-lang=plaintext>CERTS_DIR=/usr/share/elasticsearch/config/certificates</code></pre></div><p>在 <code>services.elasticsearch.volumes</code> 中添加配置，挂载证书目录:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>sevices</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>elasticsearch</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>...<span class=w>
</span><span class=w>    </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=k>type</span><span class=p>:</span><span class=w> </span>bind<span class=w>
</span><span class=w>        </span><span class=k>source</span><span class=p>:</span><span class=w> </span>./tls/certs<span class=w>
</span><span class=w>        </span><span class=k>target</span><span class=p>:</span><span class=w> </span>$CERTS_DIR<span class=w>
</span><span class=w>        </span><span class=k>read_only</span><span class=p>:</span><span class=w> </span><span class=kc>true</span></code></pre></div><p>在 <code>services.elasticsearch.environment</code> 中添加配置，启用证书:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>sevices</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>elasticsearch</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>...<span class=w>
</span><span class=w>    </span><span class=k>environment</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>xpack.security.enabled</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span><span class=w>      </span><span class=k>xpack.security.http.ssl.enabled</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span><span class=w>      </span><span class=k>xpack.security.http.ssl.key</span><span class=p>:</span><span class=w> </span>${CERTS_DIR}/${NODE_NAME}/${NODE_NAME}.key<span class=w>
</span><span class=w>      </span><span class=k>xpack.security.http.ssl.certificate_authorities</span><span class=p>:</span><span class=w> </span>${CERTS_DIR}/ca/ca.crt<span class=w>
</span><span class=w>      </span><span class=k>xpack.security.http.ssl.certificate</span><span class=p>:</span><span class=w> </span>${CERTS_DIR}/${NODE_NAME}/${NODE_NAME}.crt<span class=w>
</span><span class=w>      </span><span class=k>xpack.security.transport.ssl.enabled</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span><span class=w>      </span><span class=k>xpack.security.transport.ssl.verification_mode</span><span class=p>:</span><span class=w> </span>certificate<span class=w>
</span><span class=w>      </span><span class=k>xpack.security.transport.ssl.certificate</span><span class=p>:</span><span class=w> </span>${CERTS_DIR}/${NODE_NAME}/${NODE_NAME}.crt<span class=w>
</span><span class=w>      </span><span class=k>xpack.security.transport.ssl.certificate_authorities</span><span class=p>:</span><span class=w> </span>${CERTS_DIR}/ca/ca.crt<span class=w>
</span><span class=w>      </span><span class=k>xpack.security.transport.ssl.key</span><span class=p>:</span><span class=w> </span>${CERTS_DIR}/${NODE_NAME}/${NODE_NAME}.key</code></pre></div><h4 id=节点和集群配置>节点和集群配置</h4><p>继续在 <code>services.elasticsearch.environment</code> 中添加配置:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>sevices</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>elasticsearch</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>...<span class=w>
</span><span class=w>    </span><span class=k>environment</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>node.name</span><span class=p>:</span><span class=w> </span>${NODE_NAME}<span class=w>
</span><span class=w>      </span><span class=k>http.port</span><span class=p>:</span><span class=w> </span><span class=m>9200</span><span class=w>
</span><span class=hl><span class=w>      </span><span class=k>http.publish_port</span><span class=p>:</span><span class=w> </span><span class=m>9220</span><span class=w>
</span></span><span class=w>      </span><span class=k>network.host</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=w>
</span><span class=hl><span class=w>      </span><span class=k>network.publish_host</span><span class=p>:</span><span class=w> </span>${NODE_IP}<span class=w>
</span></span><span class=w>      </span><span class=k>transport.tcp.port</span><span class=p>:</span><span class=w> </span><span class=m>9300</span><span class=w>
</span><span class=hl><span class=w>      </span><span class=k>transport.publish_port</span><span class=p>:</span><span class=w> </span><span class=m>9320</span><span class=w>
</span></span><span class=hl><span class=w>      </span><span class=k>cluster.initial_master_nodes</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;es01.yuchi.lab:9320&#34;</span><span class=w>
</span></span><span class=hl><span class=w>      </span><span class=k>discovery.seed_hosts</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;es01.yuchi.lab:9320&#34;</span><span class=w>
</span></span><span class=w>
</span><span class=w>      </span><span class=k>xpack.security.enabled</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span><span class=w>      </span>...</code></pre></div><p>一些解释：</p><ul><li><code>publish_port</code>: 当 elastcisearch 进程监听的端口，与实际被连接的端口不一致时，需要设置 publish_port 配置，比如容器内监听了 9200，主机上公布了 9220，集群内的其他节点就会通过 9220 进行连接</li><li><code>publish_host</code>: 同样适用于容器场景，集群在节点发现时，种子节点会通知其他节点，通过 publish_host 设置的 IP 进行连接</li><li><code>initial_master_nodes</code>, <code>seed_hosts</code> 都可以使用逗号分割，设置多个</li></ul><p>同时，删除这一行:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>sevices</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>elasticsearch</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>...<span class=w>
</span><span class=w>    </span><span class=k>environment</span><span class=p>:</span><span class=w>
</span><span class=hl><span class=w>      </span><span class=k>discovery.type</span><span class=p>:</span><span class=w> </span>single-node</span></code></pre></div><h4 id=调整系统参数>调整系统参数</h4><p>内存、ulimit 相关参数直接修改 <code>docker-compose.yml</code> 即可, JVM 内存的具体数值需要根据主机的参数、业务需求和部署规划决定:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>services</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>elasticsearch</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>...<span class=w>
</span><span class=w>    </span><span class=k>environment</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>bootstrap.memory_lock</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span><span class=w>      </span><span class=k>ES_JAVA_OPTS</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-Xmx2g -Xms2g&#34;</span><span class=w>
</span><span class=w>    </span><span class=k>ulimits</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>memlock</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=k>soft</span><span class=p>:</span><span class=w> </span>-<span class=m>1</span><span class=w>
</span><span class=w>        </span><span class=k>hard</span><span class=p>:</span><span class=w> </span>-<span class=m>1</span></code></pre></div><p><code>vm.max_map_count</code> 需要在主机上修改, 同时，把这一行写入 <code>/etc/sysctl.conf</code>:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sysctl -w vm.max_map_count<span class=o>=</span><span class=m>262144</span></code></pre></div><h4 id=同步配置到各个节点>同步配置到各个节点</h4><p>将 docker-elk 项目同步到每个节点上。</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>rsync -aPe <span class=se>\
</span><span class=se></span><span class=s1>&#39;ssh -p{your-ssh-port}&#39;</span> <span class=se>\
</span><span class=se></span>--exclude <span class=o>{</span><span class=s1>&#39;tls/certs/ca.zip&#39;</span>, <span class=s1>&#39;tls/certs/bundle.zip&#39;</span><span class=o>}</span> <span class=se>\
</span><span class=se></span>../docker-elk/ es01.yuchi.lab:~/docker-elk</code></pre></div><p>本文为了方便操作，直接使用 rsync 将整个目录拷贝到目标节点上，在实际生产环境中，可以尝试使用 ansible 等工具进行自动化操作。同时，也可以使用 ansible-vault 加密证书文件，避免明文存储和拷贝。</p><h2 id=启动集群>启动集群</h2><h3 id=启动-master-节点>启动 master 节点</h3><p>前面指定了 <code>es01.yuchi.lab</code> 作为集群的主节点，先启动这个节点上的服务。ssh 登录到节点上，进入 <code>~/docker-elk</code> 目录，执行:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nv>NODE_NAME</span><span class=o>=</span>es01.yuchi.lab <span class=nv>NODE_IP</span><span class=o>=</span>10.11.12.13 sudo -E docker-compose -f docker-compose.yml up elasticsearch</code></pre></div><p>终端上的输出，注意观察高亮行的输出内容，表示服务启动成功:</p><div class=highlight><pre class=chroma><code class=language-plaintext data-lang=plaintext>Creating volume &#34;docker-elk_esdata01&#34; with local driver
Creating volume &#34;docker-elk_eslog01&#34; with local driver
Creating docker-elk_elasticsearch_1 ... done
Attaching to docker-elk_elasticsearch_1
elasticsearch_1  | Created elasticsearch keystore in /usr/share/elasticsearch/config
...
<span class=hl>elasticsearch_1  | {&#34;type&#34;: &#34;server&#34;, &#34;timestamp&#34;: &#34;2020-05-25T05:24:25,947Z&#34;, &#34;level&#34;: &#34;INFO&#34;, &#34;component&#34;: &#34;o.e.c.r.a.AllocationService&#34;, &#34;cluster.name&#34;: &#34;docker-cluster&#34;, &#34;node.name&#34;: &#34;es01.yuchi.lab&#34;, &#34;message&#34;: &#34;Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[.watcher-history-10-2020.05.25][0]]]).&#34;, &#34;cluster.uuid&#34;: &#34;uNb6qD9kStSiwxPIi9CvUw&#34;, &#34;node.id&#34;: &#34;ofLOlsGZT_OgBfJVyr1I0Q&#34;  }</span></code></pre></div><p>接下来，在主机上的另一个终端内，用 <code>curl</code> 检查节点的状态:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl -u elastic:changeme --cacert tls/certs/ca/ca.crt <span class=s1>&#39;https://es01.yuchi.lab:9220/_cluster/health?pretty=true&#39;</span>
<span class=o>{</span>
  <span class=s2>&#34;cluster_name&#34;</span> : <span class=s2>&#34;docker-cluster&#34;</span>,
<span class=hl>  <span class=s2>&#34;status&#34;</span> : <span class=s2>&#34;green&#34;</span>,
</span>  <span class=s2>&#34;timed_out&#34;</span> : false,
  <span class=s2>&#34;number_of_nodes&#34;</span> : 1,
  <span class=s2>&#34;number_of_data_nodes&#34;</span> : 1,
  <span class=s2>&#34;active_primary_shards&#34;</span> : 5,
  <span class=s2>&#34;active_shards&#34;</span> : 5,
  <span class=s2>&#34;relocating_shards&#34;</span> : 0,
  <span class=s2>&#34;initializing_shards&#34;</span> : 0,
  <span class=s2>&#34;unassigned_shards&#34;</span> : 0,
  <span class=s2>&#34;delayed_unassigned_shards&#34;</span> : 0,
  <span class=s2>&#34;number_of_pending_tasks&#34;</span> : 0,
  <span class=s2>&#34;number_of_in_flight_fetch&#34;</span> : 0,
  <span class=s2>&#34;task_max_waiting_in_queue_millis&#34;</span> : 0,
  <span class=s2>&#34;active_shards_percent_as_number&#34;</span> : 100.0
<span class=o>}</span></code></pre></div><h3 id=启动数据节点--从节点>启动数据节点(从节点)</h3><p>在另外两个主机上，分别进入 <code>docker-elk</code> 目录，再执行:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># on es02</span>
<span class=nv>NODE_NAME</span><span class=o>=</span>es02.yuchi.lab <span class=nv>NODE_IP</span><span class=o>=</span>10.11.12.14 sudo -E docker-compose -f docker-compose.tls.yml up elasticsearch
<span class=c1># on es03</span>
<span class=nv>NODE_NAME</span><span class=o>=</span>es03.yuchi.lab <span class=nv>NODE_IP</span><span class=o>=</span>10.11.12.15 sudo -E docker-compose -f docker-compose.tls.yml up elasticsearch</code></pre></div><p>终端上会输出类似下面的日志：</p><div class=highlight><pre class=chroma><code class=language-plaintext data-lang=plaintext>...
elasticsearch_1  | {&#34;type&#34;: &#34;server&#34;, &#34;timestamp&#34;: &#34;2020-05-26T02:27:45,263Z&#34;, &#34;level&#34;: &#34;INFO&#34;, &#34;component&#34;: &#34;o.e.b.BootstrapChecks&#34;, &#34;cluster.name&#34;: &#34;docker-cluster&#34;, &#34;node.name&#34;: &#34;es02.yuchi.lab&#34;, &#34;message&#34;: &#34;bound or publishing to a non-loopback address, enforcing bootstrap checks&#34; }
<span class=hl>elasticsearch_1  | {&#34;type&#34;: &#34;server&#34;, &#34;timestamp&#34;: &#34;2020-05-26T02:27:45,274Z&#34;, &#34;level&#34;: &#34;INFO&#34;, &#34;component&#34;: &#34;o.e.c.c.ClusterBootstrapService&#34;, &#34;cluster.name&#34;: &#34;docker-cluster&#34;, &#34;node.name&#34;: &#34;es02.yuchi.lab&#34;, &#34;message&#34;: &#34;skipping cluster bootstrapping as local node does not match bootstrap requirements: [es01.yuchi.lab]&#34; }
</span>elasticsearch_1  | {&#34;type&#34;: &#34;server&#34;, &#34;timestamp&#34;: &#34;2020-05-26T02:27:46,322Z&#34;, &#34;level&#34;: &#34;INFO&#34;, &#34;component&#34;: &#34;o.e.c.s.ClusterApplierService&#34;, &#34;cluster.name&#34;: &#34;docker-cluster&#34;, &#34;node.name&#34;: &#34;es02.yuchi.lab&#34;, &#34;message&#34;: &#34;master node changed {previous [], current [{es01.yuchi.lab}{ofLOlsGZT_OgBfJVyr1I0Q}{2vdYT2RGT92uqH4v8S3duQ}{10.11.12.13}{10.11.12.13:9320}{dilm}{ml.machine_memory=201400594432, ml.max_open_jobs=20, xpack.installed=true}]}, added {{es01.yuchi.lab}{ofLOlsGZT_OgBfJVyr1I0Q}{2vdYT2RGT92uqH4v8S3duQ}{10.11.12.13}{10.11.12.13:9320}{dilm}{ml.machine_memory=201400594432, ml.max_open_jobs=20, xpack.installed=true}}, term: 4, version: 80, reason: ApplyCommitRequest{term=4, version=80, sourceNode={es01.yuchi.lab}{ofLOlsGZT_OgBfJVyr1I0Q}{2vdYT2RGT92uqH4v8S3duQ}{10.11.12.13}{10.11.12.13:9320}{dilm}{ml.machine_memory=201400594432, ml.max_open_jobs=20, xpack.installed=true}}&#34; }
...</code></pre></div><p>此时再次检查集群状态,可以看到节点数量已经变成三个：</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>curl -u elastic:changeme --cacert tls/certs/ca/ca.crt <span class=s1>&#39;https://es01.yuchi.lab:9220/_cluster/health?pretty=true&#39;</span>
<span class=o>{</span>
  <span class=s2>&#34;cluster_name&#34;</span> : <span class=s2>&#34;docker-cluster&#34;</span>,
  <span class=s2>&#34;status&#34;</span> : <span class=s2>&#34;green&#34;</span>,
  <span class=s2>&#34;timed_out&#34;</span> : false,
<span class=hl>  <span class=s2>&#34;number_of_nodes&#34;</span> : 3,
</span><span class=hl>  <span class=s2>&#34;number_of_data_nodes&#34;</span> : 3,
</span>  <span class=s2>&#34;active_primary_shards&#34;</span> : 8,
  <span class=s2>&#34;active_shards&#34;</span> : 16,
  <span class=s2>&#34;relocating_shards&#34;</span> : 0,
  <span class=s2>&#34;initializing_shards&#34;</span> : 0,
  <span class=s2>&#34;unassigned_shards&#34;</span> : 0,
  <span class=s2>&#34;delayed_unassigned_shards&#34;</span> : 0,
  <span class=s2>&#34;number_of_pending_tasks&#34;</span> : 0,
  <span class=s2>&#34;number_of_in_flight_fetch&#34;</span> : 0,
  <span class=s2>&#34;task_max_waiting_in_queue_millis&#34;</span> : 0,
  <span class=s2>&#34;active_shards_percent_as_number&#34;</span> : 100.0
<span class=o>}</span></code></pre></div><h3 id=重置内建账户密码>重置内建账户密码</h3><p>在 master 节点所在主机上执行命令:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nv>NODE_NAME</span><span class=o>=</span>es01.yuchi.lab <span class=nv>NODE_IP</span><span class=o>=</span>10.11.12.13 <span class=se>\
</span><span class=se></span>sudo -E docker-compose -f docker-compose.yml <span class=se>\
</span><span class=se></span><span class=nb>exec</span> -T elasticsearch bin/elasticsearch-setup-passwords auto <span class=se>\
</span><span class=se></span>--batch --url https://localhost:9200</code></pre></div><div class=highlight><pre class=chroma><code class=language-plaintext data-lang=plaintext>Changed password for user apm_system
PASSWORD apm_system = 4QHu6U58oH3Uz9dEYbQa

Changed password for user kibana
PASSWORD kibana = rGPTCtn2B3uUJbyMc79y

Changed password for user logstash_system
PASSWORD logstash_system = DzNT28wMiPjAOPuSQUBV

Changed password for user beats_system
PASSWORD beats_system = 8xHjc6eMIIDP8dj3KLVm

Changed password for user remote_monitoring_user
PASSWORD remote_monitoring_user = nvgD7uPvHiy86MkAEiPe

Changed password for user elastic
PASSWORD elastic = l6yM662rGcKKoA3lOxSM</code></pre></div><p>保存好输出的结果.并修改下面三个文件中的 elastic 密码，为后面启动 kibana,logstash 做准备:</p><ul><li>kibana/config/kibana.yml</li><li>logstash/config/logstash.yml</li><li>logstash/pipeline/logstash.conf</li></ul><h3 id=启动-kibana>启动 kibana</h3><p>修改 <code>docker-compose.yml</code> 中的 <code>services.kibana</code> 部分为:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>kibana</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>build</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>context</span><span class=p>:</span><span class=w> </span>kibana/<span class=w>
</span><span class=w>    </span><span class=k>args</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=k>ELK_VERSION</span><span class=p>:</span><span class=w> </span>$ELK_VERSION<span class=w>
</span><span class=w>  </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=k>type</span><span class=p>:</span><span class=w> </span>bind<span class=w>
</span><span class=w>      </span><span class=k>source</span><span class=p>:</span><span class=w> </span>./kibana/config/kibana.yml<span class=w>
</span><span class=w>      </span><span class=k>target</span><span class=p>:</span><span class=w> </span>/usr/share/kibana/config/kibana.yml<span class=w>
</span><span class=w>      </span><span class=k>read_only</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=hl><span class=w>    </span>- <span class=k>type</span><span class=p>:</span><span class=w> </span>bind<span class=w>
</span></span><span class=hl><span class=w>      </span><span class=k>source</span><span class=p>:</span><span class=w> </span>./tls/certs<span class=w>
</span></span><span class=hl><span class=w>      </span><span class=k>target</span><span class=p>:</span><span class=w> </span>$CERTS_DIR<span class=w>
</span></span><span class=hl><span class=w>      </span><span class=k>read_only</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span><span class=hl><span class=w>  </span><span class=k>environment</span><span class=p>:</span><span class=w>
</span></span><span class=hl><span class=w>    </span><span class=k>ELASTICSEARCH_HOSTS</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://es01.yuchi.lab:9220&#34;</span><span class=w>
</span></span><span class=hl><span class=w>    </span><span class=k>ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${CERTS_DIR}/ca/ca.crt&#34;</span><span class=w>
</span></span><span class=w>  </span><span class=k>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=s2>&#34;5600:5600&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>networks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- elk<span class=w>
</span><span class=hl><span class=w>  </span><span class=k>depends_on</span><span class=p>:</span><span class=w>
</span></span><span class=hl><span class=w>    </span>- elasticsearch</span></code></pre></div><ul><li>11-14 行将证书挂载到容器里</li><li>15-17 行指定 elasticsearch 地址使用 HTTPS 协议，并指定 CA 证书的路径<ul><li><code>ELASTICSEARCH_HOSTS</code> 可以使用逗号分割写多个地址</li><li>如果 elasticsearch 与 kibana 不运行在同一台主机上，需要删除 22-23 行</li></ul></li></ul><p>然后到 master 节点所在主机上执行:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nv>NODE_NAME</span><span class=o>=</span>es01.yuchi.lab <span class=nv>NODE_IP</span><span class=o>=</span>10.11.12.13 <span class=se>\
</span><span class=se></span>sudo -E docker-compose -f docker-compose.yml up --build kibana</code></pre></div><p>启动成功时，终端里输出:</p><div class=highlight><pre class=chroma><code class=language-plaintext data-lang=plaintext>...
kibana_1         | {&#34;type&#34;:&#34;log&#34;,&#34;@timestamp&#34;:&#34;2020-05-27T12:11:20Z&#34;,&#34;tags&#34;:[&#34;info&#34;,&#34;http&#34;,&#34;server&#34;,&#34;Kibana&#34;],&#34;pid&#34;:6,&#34;message&#34;:&#34;http server running at http://0:5601&#34;}
...</code></pre></div><h3 id=启动-logstash>启动 logstash</h3><p>修改 <code>logstash/config/logstash.yaml</code>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=c># 修改 ES 地址</span><span class=w>
</span><span class=w></span><span class=k>xpack.monitoring.elasticsearch.hosts</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;https://es01.yuchi.lab:9220&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c># 添加 CA 证书配置</span><span class=w>
</span><span class=w></span><span class=k>xpack.monitoring.elasticsearch.ssl.certificate_authority</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${LS_CACERT_FILE}&#34;</span></code></pre></div><p>修改 <code>logstash/pipeline/logstash.conf</code> 中的 output 部分为:</p><div class=highlight><pre class=chroma><code class=language-plaintext data-lang=plaintext>output {
    elasticsearch {
        hosts =&gt; &#34;https://es01.yuchi.lab:9220&#34;
        cacert =&gt; &#34;${LS_CACERT_FILE}&#34;
        user =&gt; &#34;elastic&#34;
        password =&gt; &#34;real-password&#34;
    }
}</code></pre></div><p>修改 <code>docker-compose.yml</code> 中的 <code>services.logstash</code> (高亮的部分):</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>logstash</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>...<span class=w>
</span><span class=hl><span class=w>    </span>- <span class=k>type</span><span class=p>:</span><span class=w> </span>bind<span class=w>
</span></span><span class=hl><span class=w>      </span><span class=k>source</span><span class=p>:</span><span class=w> </span>./tls/certs<span class=w>
</span></span><span class=hl><span class=w>      </span><span class=k>target</span><span class=p>:</span><span class=w> </span>$CERTS_DIR<span class=w>
</span></span><span class=hl><span class=w>      </span><span class=k>read_only</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span><span class=w>  </span><span class=k>environment</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=k>LS_JAVA_OPTS</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-Xmx256m -Xms256m&#34;</span><span class=w>
</span><span class=hl><span class=w>    </span><span class=k>LS_CACERT_FILE</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${CERTS_DIR}/ca/ca.crt&#34;</span><span class=w>
</span></span><span class=w>  </span>...</code></pre></div><p>再执行启动命令即可:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nv>NODE_NAME</span><span class=o>=</span>es01.yuchi.lab <span class=nv>NODE_IP</span><span class=o>=</span>10.11.12.13 <span class=se>\
</span><span class=se></span>sudo -E docker-compose -f docker-compose.yml up --build logstash</code></pre></div><h3 id=注入测试数据>注入测试数据</h3><p>把 <code>/var/log/kern.log</code> 通过 logstash 注入到集群中:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo cat /var/log/kern.log <span class=p>|</span> nc -c localhost <span class=m>5000</span></code></pre></div><p>登录 kibana,在 <code>Settings.Kibana.Index Patterns</code> 页面，新建 <code>logstash*</code> pattern, 再回到 kibana 首页就可以看到数据了。</p><div class="gallery caption-position-bottom caption-effect-slide hover-effect-zoom hover-transition" itemscope itemtype=http://schema.org/ImageGallery><link rel=stylesheet href=/vendor/css/hugo-easy-gallery.css><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(images/es/kibana-create-pattern.png)><img itemprop=thumbnail src=images/es/kibana-create-pattern.png alt="kibana create index pattern"></div><a href=images/es/kibana-create-pattern.png itemprop=contentUrl></a></figure></div><div class=box><figure itemprop=associatedMedia itemscope itemtype=http://schema.org/ImageObject><div class=img style=background-image:url(images/es/kibana-data.png)><img itemprop=thumbnail src=images/es/kibana-data.png alt="kibana data"></div><a href=images/es/kibana-data.png itemprop=contentUrl></a></figure></div></div><h2 id=完整配置>完整配置</h2><p>上述修改后的完整配置放在 <a href=https://github.com/wych42/docker-elk/tree/prod-demo rel=noreferrer target=_blank>Github</a>.</p><p>以上。</p><hr width=100% id=EOF><p style=color:#777>最后修改于 2020-06-04</p></div><div class=post-related></div></div><nav class=post-pagination><a class=newer-posts>下回<br>已经到头啦。</a>
<a class=older-posts href=https://yuchi.me/post/export-org-mode-in-chinese-to-pdf-with-custom-latex-class/>上回<br>Org-mode 导出中文 PDF</a></nav><div class=post-comment-wrapper><div class=comments><vue-disqus shortname=chis-journal></vue-disqus></div><noscript><noscript>请开启 JavaScript 以便使用评论服务。</noscript></noscript><a href=https://disqus.com/ class=dsq-brlink>Comments powered by <span class=logo-disqus>Disqus</span></a></div><div class=post-footer-tags><i class=material-icons>label</i>
<a href=/tags/elasticsearch>elasticsearch</a>
&nbsp;
<a href=/tags/docker>docker</a>
&nbsp;
<a href=/tags/tls>tls</a>
&nbsp;</div></div></div></div></div><div id=single-column-footer>Written with <a target=_blank rel="noreferrer noopener" href=https://www.gnu.org/software/emacs/>Emacs</a> and <a target=_blank rel="noreferrer noopener" href=https://orgmode.org/>Org-mode</a>.<br>Rendered by <a target=_blank rel="noreferrer noopener" href=https://gohugo.io>Hugo</a>.<br>Theme <a target=_blank rel="noreferrer noopener" href=https://github.com/amazingrise/hugo-theme-diary>Diary</a>(Modified).<br>Converted by <a target=_blank rel="noreferrer noopener" href=https://ox-hugo.scripter.co/>ox-hugo</a>.<br>&copy;
2020 Chi's Journal</div></div><script>let app;app=new Vue({el:'#app',data:{scrollY:0,navOpacity:0,isDrawerOpen:false,mounted:false,isDarkMode:false},methods:{sgn(t,x){let k=1./(1.-2*t);if(x<=t)return 0;else if(x>=1-t)return 1;else{return k*(x-t);}},handleScroll(){this.scrollY=window.scrollY;this.navOpacity=this.sgn(.0,Math.min(1,Math.max(0,window.scrollY/(this.pageHeadHeight()-this.navBarHeight()*0.8))));const{navBar,navBackground,navTitle,extraContainer,streamContainer}=this.$refs;if(this.navOpacity>=1){navBackground.style.opacity=1;navTitle.style.opacity=1;}else{navBackground.style.opacity=0;navTitle.style.opacity=0;}},handleResize(){const{navBar,navBackground,navTitle,extraContainer,streamContainer}=this.$refs;extraContainer.style.left=(streamContainer.offsetWidth-extraContainer.offsetWidth)+'px';},navBarHeight(){return this.$refs.navBar.offsetHeight;},pageHeadHeight(){return this.$refs.pageHead.offsetHeight;},toggleDrawer(){this.isDrawerOpen=!this.isDrawerOpen;document.getElementsByTagName('html')[0].style.overflow=this.isDrawerOpen?'hidden':'unset';},closeDrawer(){this.isDrawerOpen=false;document.getElementsByTagName('html')[0].style.overflow=this.isDrawerOpen?'hidden':'unset';},toggleDarkMode(){this.isDarkMode=!this.isDarkMode;if(this.isDarkMode==true){document.cookie="night=1;path=/";document.body.classList.add("night");}else{document.cookie="night=0;path=/";document.body.classList.remove("night");}}},created(){window.addEventListener('scroll',this.handleScroll);window.addEventListener('resize',this.handleResize);window._nonDesktop=function(){let check=false;(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check=true;})(navigator.userAgent||navigator.vendor||window.opera);return check;};var night=document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/,"$1");if(night==""){if(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches){}}else{if(night=="1"){this.toggleDarkMode();}}},mounted(){this.handleScroll();this.handleResize();this.mounted=true;},destroyed(){window.removeEventListener('scroll',this.handleScroll);window.removeEventListener('resize',this.handleResize);}});</script><script src=https://yuchi.me//js/journal.js></script><script src=/vendor/js/load-photoswipe.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin=anonymous></script><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div></body></html>