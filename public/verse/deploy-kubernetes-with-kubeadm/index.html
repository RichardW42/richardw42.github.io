<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
    
    
      <link href="/css/fonts.css" rel="stylesheet" type="text/css">
    
  

  
  <title>用 kubeadm 部署简易 kubernetes 集群</title>

  
  
  <link rel="stylesheet" href="/css/hugo-octopress.css">

  
  

  
    <link rel="stylesheet" href="/css/fork-awesome.min.css">
  

  
  <link href="https://yuchi.me/favicon.png" rel="icon">

  
  

  <meta name="description" content="" />
  <meta name="keywords" content="">
  <meta name="author" content="chi">

  
  <meta name="generator" content="Hugo 0.59.1" />

  
  

  
  
</head>
<body>


<header role="banner">
<hgroup>
  
  <h1><a href="https://yuchi.me/">Chi&#39;s Journal</a></h1>
    <h2>- Ecclesiastes 1.11</h2>
</hgroup></header>


<nav role="navigation">
<fieldset class="mobile-nav">
  
  <select onchange="location = this.value;">
    <option value="">Navigate…</option>
      
        <option value="https://yuchi.me/">» Blog</option>
      
        <option value="https://yuchi.me/verse">» Verse</option>
      
        <option value="https://yuchi.me/archive">» Archive</option>
      
  </select>
</fieldset>


<ul class="main-navigation">
  
  
    
      <li><a href="https://yuchi.me/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="https://yuchi.me/verse" title="Verse" >Verse</a></li>
    
  
    
      <li><a href="https://yuchi.me/archive" title="Archive" >Archive</a></li>
    
  
</ul>

<ul class="subscription">
  
    
        <a href="https://yuchi.me/index.xml" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-lg"></i></a>
    
  
</ul>


  <form action="https://www.google.com/search" method="get" target="_blank">
    <fieldset role="search">
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      <input type="hidden" name="q" value="site:https://yuchi.me/" />
    </fieldset>
  </form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
  <p class="meta">Dec 4, 2019
     - 2 minute read 
     - <a href="https://yuchi.me/verse/deploy-kubernetes-with-kubeadm/#disqus_thread">Comments</a>

    
    
      - <a class="label" href="https://yuchi.me/categories/%e7%83%82%e7%ac%94%e5%a4%b4/">烂笔头 </a>
    
  </p>
  <h1 class="entry-title">
     用 kubeadm 部署简易 kubernetes 集群 
  </h1>
</header>


        <div class="entry-content">
          
          
          
            <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#准备">准备</a>
<ul>
<li><a href="#设备和网络">设备和网络</a></li>
<li><a href="#安装依赖">安装依赖</a>
<ul>
<li><a href="#安装-docker">安装 docker</a></li>
<li><a href="#安装-kubeadm-kubelet-kubectl">安装 kubeadm/kubelet/kubectl</a></li>
</ul></li>
</ul></li>
<li><a href="#部署集群">部署集群</a>
<ul>
<li><a href="#初始化控制节点">初始化控制节点</a></li>
<li><a href="#启用-flannel">启用 flannel</a></li>
<li><a href="#worker-加入集群">worker 加入集群</a></li>
<li><a href="#控制节点兼任-worker">控制节点兼任 worker</a></li>
<li><a href="#节点打标签">节点打标签</a></li>
</ul></li>
<li><a href="#善后">善后</a></li>
<li><a href="#命令备忘">命令备忘</a></li>
</ul></li>
</ul>
</nav>
          
          

<h2 id="准备">准备</h2>

<ul>
<li>这次部署能用到的设备都是小型号得 vps，零散在不同得公网区域，所以要部署一个跨公网集群。<br /></li>
<li>各项配置都使用最简化得模式，比如单主节点，主要目的是自用+测试。<br /></li>
<li>通读和参考文档： <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm" target="_blank">Bootstrapping clusters with kubeadm</a>。<br />
<br />
<br /></li>
</ul>

<h3 id="设备和网络">设备和网络</h3>

<p>三台设备：</p>

<ul>
<li>控制节点（同时也当做worker用）: 赵云, 2 Core, 4G(x1)<br /></li>
<li>worker: 赵云，1 Core, 1G(x2)<br /></li>
<li>操作系统: debian 9<br />
<br /></li>
</ul>

<p>网络：三台设备在三个地区，各有公网，内网不通。</p>

<h3 id="安装依赖">安装依赖</h3>

<h4 id="安装-docker">安装 docker</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">apt-get install -y <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        apt-transport-https <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        ca-certificates <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        gnupg2 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        software-properties-common

curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -

add-apt-repository <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#e6db74">&#34;deb [arch=amd64] https://download.docker.com/linux/debian \
</span><span style="color:#e6db74">   </span><span style="color:#66d9ef">$(</span>lsb_release -cs<span style="color:#66d9ef">)</span><span style="color:#e6db74"> \
</span><span style="color:#e6db74">   stable&#34;</span>

apt-get update <span style="color:#f92672">&amp;&amp;</span> apt-get install -y docker-ce docker-ce-cli containerd.io</code></pre></div>
<p>docker 使用 systemd 作为 <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/#kubeadm-blocks-waiting-for-control-plane-during-installation" target="_blank">cgroupdriver</a>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat &gt; /etc/docker/daemon.json <span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">{
</span><span style="color:#e6db74">  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span><span style="color:#e6db74">  &#34;log-driver&#34;: &#34;json-file&#34;,
</span><span style="color:#e6db74">  &#34;log-opts&#34;: {
</span><span style="color:#e6db74">    &#34;max-size&#34;: &#34;100m&#34;
</span><span style="color:#e6db74">  },
</span><span style="color:#e6db74">  &#34;storage-driver&#34;: &#34;overlay2&#34;
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74">EOF</span>
systemctl restart docker</code></pre></div>
<h4 id="安装-kubeadm-kubelet-kubectl">安装 kubeadm/kubelet/kubectl</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">apt-get update <span style="color:#f92672">&amp;&amp;</span> apt-get install -y apt-transport-https
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -
cat <span style="color:#e6db74">&lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list
</span><span style="color:#e6db74">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
</span><span style="color:#e6db74">EOF</span>
apt-get update
apt-get install -y kubelet kubeadm kubectl</code></pre></div>
<h2 id="部署集群">部署集群</h2>

<h3 id="初始化控制节点">初始化控制节点</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubeadm init --control-plane-endpoint<span style="color:#f92672">=</span>&lt;your-endpoint-fqdn&gt; --pod-network-cidr<span style="color:#f92672">=</span><span style="color:#ae81ff">192</span>.168.0.0/16 --image-repository<span style="color:#f92672">=</span>registry.aliyuncs.com/google_containers  --upload-certs</code></pre></div>
<ul>
<li><your\_endpoint\_fqdn> 替换为集群的控制节点 IP 地址或者域名。<br /></li>
<li>cidr 按照 flannel 的<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network" target="_blank">文档</a>设置。<br /></li>
<li>国内的机器初始化时，image repository 替换为阿里云得镜像。<br />
<br /></li>
</ul>

<p>根据屏幕输出，配置好 kubeconfig</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config</code></pre></div>
<h3 id="启用-flannel">启用 flannel</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sysctl net.bridge.bridge-nf-call-iptables<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml</code></pre></div>
<h3 id="worker-加入集群">worker 加入集群</h3>

<p>在 kubeadm init 结束时，终端输出的命令，拷贝到 worker 节点上执行。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"> kubeadm join k8s.xiatiao.io:6443 --token &lt;your-token&gt; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--discovery-token-ca-cert-hash sha256:&lt;your-hash&gt;</code></pre></div>
<p>如果错过了这段输出，可以用下面得命令生成：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubeadm token create --print-join-command</code></pre></div>
<h3 id="控制节点兼任-worker">控制节点兼任 worker</h3>

<p>想在控制节点上也跑一些任务，需要解除限制:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl taint nodes --all node-role.kubernetes.io/master-</code></pre></div>
<h3 id="节点打标签">节点打标签</h3>

<p>三个节点，一个设置为 forwarder， 两个设置为 backend:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl lable nodes &lt;nodename&gt; role<span style="color:#f92672">=</span>&lt;role&gt;</code></pre></div>
<h2 id="善后">善后</h2>

<p>至此，一个单节点的 kubernetes 集群就配置完成了，但是，由于三个设备在三个公网区域里，内网互不相同。虽然 api-server-address 是公网可用的，但是比如 <code>kubectl logs</code> 之类的命令，会尝试直接连接 worker 节点的内网地址，显然是不通的。这就导致了，虽然 pods 能被调度到各个节点上，但是集群「内部」的网络是不通的，services 就用不了。</p>

<p>解决方案有几种：</p>

<ul>
<li><code>--advertise-address</code> 设置为设备的公网地址, 通过 kubeadm 执行的话，要求这个地址在设备上能看到，类似某赵云用了 elastic ip 就不行。<br /></li>
<li>配置 nat 转发<br />

<ul>
<li>在控制节点上: <code>iptables -t nat -A OUTPUT -d &lt;worker private ip&gt; -j DNAT --to-destination &lt;worker public ip&gt;</code><br /></li>
<li>在 worker 节点上： <code>iptables -t nat -A OUTPUT -d &lt;master private ip&gt; -j DNAT --to-destination &lt;master public ip&gt;</code><br /></li>
</ul></li>
<li>用类似 wireguard, slack/nebula 之类的工具，先把各个设备组一个 overlay network，再部署 kubernetes 集群。<br />
<br />
<br /></li>
</ul>

<h2 id="命令备忘">命令备忘</h2>

<ul>
<li><p>一键毁灭集群：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#66d9ef">for</span> i in <span style="color:#66d9ef">$(</span>kubectl get nodes | tail -n +2 | awk <span style="color:#e6db74">&#39;{print $1}&#39;</span> <span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span> kubectl drain $i --delete-local-data --force --ignore-daemonsets; kubectl delete node $i; <span style="color:#66d9ef">done</span>
kubeadm reset
iptables -F <span style="color:#f92672">&amp;&amp;</span> iptables -t nat -F <span style="color:#f92672">&amp;&amp;</span> iptables -t mangle -F <span style="color:#f92672">&amp;&amp;</span> iptables -X</code></pre></div></li>
</ul>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">chi</span></span>
    
    <time>Dec 4, 2019</time>
    
      <span class="categories">
        Tags:
        
          <a class="category" href="https://yuchi.me/tags/kubernetes">kubernetes</a>  
    
    </span>
  </p>

  

  <p class="meta">
    
        <a class="basic-alignment left" href="https://yuchi.me/verse/golang-byte-vs-string/" title="golang []byte vs string">golang []byte vs string</a>
    

    
  </p>
  
    
      <div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
      
      
      
      if (window.location.hostname == "localhost")
          return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'chis-journal';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    

    <p>
      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      
      
      
      
      
         
      
      
      
      
      
      
      
      

    
    
    </li>
  </ul>

  

  

  
  
  
</aside>

  </div>
</div>

<footer role="contentinfo">
    <p>Copyright &copy; 2019 chi - <a
            href="https://yuchi.me/license/">License</a> -
        <span class="credit">Written with <a target="_blank" href="https://www.gnu.org/software/emacs/">Emacs</a> and <a
                target="_blank" href="https://orgmode.org/">Org
                Mode</a>. Rendered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank"
                href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
    </p>
</footer>






</body>

</html>
